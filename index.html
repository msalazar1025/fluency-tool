<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fluency Practice - Google Sites Compatible</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      background-color: #f5f5f5;
      padding: 10px;
    }
    
    .container {
      max-width: 850px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      text-align: center;
      margin-bottom: 15px;
      color: #333;
      font-size: 1.8em;
    }
    
    .compatibility-notice {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .compatibility-notice.success {
      background-color: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }
    
    .compatibility-notice.error {
      background-color: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }
    
    .instructions {
      background-color: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 5px solid #2196F3;
    }
    
    .instructions h3 {
      margin-bottom: 10px;
      color: #1565C0;
    }
    
    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    button {
      padding: 12px 25px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      color: white;
      background-color: #4CAF50;
      transition: background-color 0.3s;
    }
    
    button:hover:not(:disabled) {
      background-color: #45a049;
    }
    
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .stop-btn {
      background-color: #f44336;
    }
    
    .stop-btn:hover:not(:disabled) {
      background-color: #d32f2f;
    }
    
    .test-btn {
      background-color: #ff9800;
    }
    
    .test-btn:hover:not(:disabled) {
      background-color: #f57c00;
    }
    
    #timer {
      font-size: 64px;
      font-weight: bold;
      text-align: center;
      margin: 20px 0;
      color: #333;
    }
    
    .timer.warning {
      color: #ff9800;
    }
    
    .timer.danger {
      color: #f44336;
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .status-box {
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      font-size: 14px;
    }
    
    .api-status {
      background-color: #fff3e0;
      color: #e65100;
    }
    
    .api-status.checking {
      background-color: #e3f2fd;
      color: #1565c0;
      animation: pulse 1.5s infinite;
    }
    
    .api-status.ready {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    
    .api-status.error {
      background-color: #ffebee;
      color: #c62828;
    }
    
    .session-status {
      background-color: #f3e5f5;
      color: #7b1fa2;
    }
    
    .session-status.active {
      background-color: #e8f5e9;
      color: #2e7d32;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    #speechText {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
      min-height: 60px;
      font-style: italic;
      border: 2px dashed #4caf50;
      max-height: 120px;
      overflow-y: auto;
      font-size: 14px;
    }
    
    .passage {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      line-height: 1.8;
      font-size: 16px;
    }
    
    .passage h3 {
      margin-bottom: 15px;
      color: #333;
    }
    
    .passage p {
      margin-bottom: 15px;
      text-indent: 2em;
    }
    
    .results {
      background-color: #e8f4f8;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }
    
    .results.active {
      display: block;
    }
    
    .results h3 {
      margin-bottom: 15px;
      color: #333;
      text-align: center;
    }
    
    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .result-box {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .result-label {
      font-weight: bold;
      color: #666;
      margin-bottom: 8px;
      font-size: 12px;
    }
    
    .result-value {
      font-size: 28px;
      font-weight: bold;
      color: #2196F3;
    }
    
    .troubleshooting {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      display: none;
    }
    
    .troubleshooting.show {
      display: block;
    }
    
    .troubleshooting h4 {
      margin-bottom: 10px;
      color: #333;
    }
    
    .troubleshooting ul {
      margin-left: 20px;
    }
    
    .troubleshooting li {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé§ Fluency Practice Tool</h1>
    
    <div class="compatibility-notice" id="compatibilityNotice">
      <strong>‚è≥ Checking browser compatibility...</strong>
    </div>
    
    <div class="instructions">
      <h3>Instructions:</h3>
      <ol>
        <li>First, click "Test Speech Recognition" to verify it works</li>
        <li>If the test works, click "Start Practice" to begin</li>
        <li>Read the passage aloud clearly for 60 seconds</li>
        <li>View your results when the timer finishes</li>
      </ol>
    </div>
    
    <div class="controls">
      <button id="testButton" class="test-btn">Test Speech Recognition</button>
      <button id="startButton" disabled>Start Practice</button>
      <button id="stopButton" class="stop-btn" style="display: none;">Stop</button>
    </div>
    
    <div id="timer">1:00</div>
    
    <div class="status-grid">
      <div class="status-box api-status checking" id="apiStatus">
        üîç Checking Speech API...
      </div>
      <div class="status-box session-status" id="sessionStatus">
        üìä Session: Ready
      </div>
    </div>
    
    <div id="speechText">
      Speech recognition results will appear here...
    </div>
    
    <div class="passage">
      <h3>An Unusual Burglar</h3>
      <p>Theft is a serious crime. If someone stole something from you, you would most likely not be too forgiving. You would probably be very upset if the stealing continued for years. There is a place in California where thefts take place nightly. Strangely, though, most people there just laugh when their items disappear. That is because the culprit is a cat.</p>
      
      <p>Jean Chu and her family adopted Dusty, their pet cat, a few years ago. Not long after he moved in, the family members started finding odd objects lying around. One day they would find a glove and an unfamiliar towel. The next day there would be a pot holder and a sock. At first no one knew what to think about the items that mysteriously appeared on the porch or in the yard. Soon they realized that the objects always showed up in the morning. And which member of the family tended to roam every night? That would be Dusty.</p>
    </div>
    
    <div class="troubleshooting" id="troubleshooting">
      <h4>üîß Troubleshooting Speech Recognition</h4>
      <ul>
        <li><strong>Chrome/Edge:</strong> These browsers work best with speech recognition</li>
        <li><strong>HTTPS Required:</strong> Speech recognition only works on secure sites</li>
        <li><strong>Microphone:</strong> Click "Allow" when prompted for microphone access</li>
        <li><strong>Google Sites:</strong> Some iframe restrictions may apply</li>
        <li><strong>Alternative:</strong> Try opening this tool in a new tab/window</li>
      </ul>
    </div>
    
    <div class="results" id="results">
      <h3>üìà Your Results</h3>
      
      <div class="result-grid">
        <div class="result-box">
          <div class="result-label">Words Spoken</div>
          <div id="totalWords" class="result-value">0</div>
        </div>
        <div class="result-box">
          <div class="result-label">Reading Speed</div>
          <div id="wpm" class="result-value">0</div>
          <div class="result-label" style="font-size: 10px;">words/minute</div>
        </div>
        <div class="result-box">
          <div class="result-label">Time Used</div>
          <div id="timeUsed" class="result-value">0</div>
          <div class="result-label" style="font-size: 10px;">seconds</div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Global variables
    let speechRecognition = null;
    let isListening = false;
    let timer = null;
    let seconds = 60;
    let isRunning = false;
    let wordCount = 0;
    let transcriptText = '';
    let initializationAttempts = 0;
    let maxInitializationAttempts = 3;
    
    // DOM elements
    const testButton = document.getElementById('testButton');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const timerElement = document.getElementById('timer');
    const apiStatus = document.getElementById('apiStatus');
    const sessionStatus = document.getElementById('sessionStatus');
    const speechText = document.getElementById('speechText');
    const results = document.getElementById('results');
    const compatibilityNotice = document.getElementById('compatibilityNotice');
    const troubleshooting = document.getElementById('troubleshooting');
    
    // Enhanced initialization for Google Sites compatibility
    function initializeSpeechRecognition() {
      return new Promise((resolve, reject) => {
        initializationAttempts++;
        
        console.log(`Initialization attempt ${initializationAttempts}`);
        
        // Check if we're in an iframe (Google Sites)
        const isInIframe = window.self !== window.top;
        if (isInIframe) {
          console.log('Running inside iframe (Google Sites)');
        }
        
        // Check for Speech Recognition support
        if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
          console.log('Speech Recognition not supported');
          reject('Speech Recognition not supported in this browser');
          return;
        }
        
        try {
          // Create recognition instance
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          speechRecognition = new SpeechRecognition();
          
          // Configure recognition
          speechRecognition.continuous = true;
          speechRecognition.interimResults = true;
          speechRecognition.lang = 'en-US';
          speechRecognition.maxAlternatives = 1;
          
          // Set up event handlers
          speechRecognition.onstart = function() {
            console.log('Speech recognition started');
            isListening = true;
            updateApiStatus('ready', '‚úÖ Speech API: Listening');
          };
          
          speechRecognition.onresult = function(event) {
            let interimTranscript = '';
            let finalTranscript = '';
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
              const transcript = event.results[i][0].transcript;
              if (event.results[i].isFinal) {
                finalTranscript += transcript + ' ';
              } else {
                interimTranscript += transcript;
              }
            }
            
            if (finalTranscript) {
              transcriptText += finalTranscript;
              const words = finalTranscript.trim().split(/\s+/).filter(word => word.length > 0);
              wordCount += words.length;
            }
            
            speechText.textContent = transcriptText + interimTranscript;
          };
          
          speechRecognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            isListening = false;
            
            if (event.error === 'not-allowed') {
              updateApiStatus('error', '‚ùå Microphone Access Denied');
              showTroubleshooting();
            } else if (event.error === 'no-speech') {
              // This is normal, continue
              console.log('No speech detected, continuing...');
            } else {
              updateApiStatus('error', `‚ùå Error: ${event.error}`);
            }
          };
          
          speechRecognition.onend = function() {
            console.log('Speech recognition ended');
            isListening = false;
            
            if (isRunning) {
              // Restart if session is active
              setTimeout(() => {
                if (isRunning && speechRecognition) {
                  try {
                    speechRecognition.start();
                  } catch (e) {
                    console.error('Error restarting recognition:', e);
                  }
                }
              }, 100);
            } else {
              updateApiStatus('ready', '‚úÖ Speech API: Ready');
            }
          };
          
          // Test initialization by attempting to start and immediately stop
          console.log('Testing speech recognition initialization...');
          speechRecognition.start();
          
          // Stop the test after a short delay
          setTimeout(() => {
            if (speechRecognition && isListening) {
              speechRecognition.stop();
              resolve(true);
            }
          }, 500);
          
        } catch (error) {
          console.error('Error creating speech recognition:', error);
          reject(error.message);
        }
      });
    }
    
    // Update API status display
    function updateApiStatus(type, message) {
      apiStatus.className = `status-box api-status ${type}`;
      apiStatus.textContent = message;
    }
    
    // Show troubleshooting information
    function showTroubleshooting() {
      troubleshooting.classList.add('show');
    }
    
    // Test speech recognition
    function testSpeechRecognition() {
      if (!speechRecognition) {
        alert('Speech recognition not initialized. Please refresh the page and try again.');
        return;
      }
      
      updateApiStatus('checking', 'üß™ Testing...');
      speechText.textContent = 'Testing speech recognition... Say something!';
      
      try {
        speechRecognition.start();
        
        // Stop test after 5 seconds
        setTimeout(() => {
          if (isListening && !isRunning) {
            speechRecognition.stop();
            updateApiStatus('ready', '‚úÖ Test Complete');
          }
        }, 5000);
        
      } catch (error) {
        console.error('Test failed:', error);
        updateApiStatus('error', '‚ùå Test Failed');
        showTroubleshooting();
      }
    }
    
    // Start practice session
    function startPractice() {
      if (isRunning || !speechRecognition) return;
      
      // Reset session
      wordCount = 0;
      transcriptText = '';
      seconds = 60;
      isRunning = true;
      
      // Update UI
      startButton.style.display = 'none';
      stopButton.style.display = 'inline-block';
      results.classList.remove('active');
      speechText.textContent = 'Start reading the passage aloud...';
      sessionStatus.textContent = 'üìä Session: Active';
      sessionStatus.className = 'status-box session-status active';
      
      // Start speech recognition
      try {
        speechRecognition.start();
      } catch (error) {
        console.error('Failed to start recognition:', error);
        if (error.name === 'InvalidStateError') {
          speechRecognition.stop();
          setTimeout(() => {
            try {
              speechRecognition.start();
            } catch (e) {
              console.error('Restart failed:', e);
            }
          }, 100);
        }
      }
      
      // Start timer
      timer = setInterval(updateTimer, 1000);
    }
    
    // Stop practice session
    function stopPractice() {
      if (!isRunning) return;
      
      clearInterval(timer);
      isRunning = false;
      
      if (speechRecognition && isListening) {
        speechRecognition.stop();
      }
      
      // Calculate results
      const timeUsed = 60 - seconds;
      const wpm = Math.round((wordCount / timeUsed) * 60);
      
      // Update results
      document.getElementById('totalWords').textContent = wordCount;
      document.getElementById('wpm').textContent = wpm;
      document.getElementById('timeUsed').textContent = timeUsed;
      
      // Show results
      results.classList.add('active');
      
      // Update UI
      startButton.style.display = 'inline-block';
      stopButton.style.display = 'none';
      sessionStatus.textContent = 'üìä Session: Complete';
      sessionStatus.className = 'status-box session-status';
      
      // Reset timer
      timerElement.textContent = '1:00';
      timerElement.className = '';
    }
    
    // Update timer
    function updateTimer() {
      seconds--;
      
      const minutes = Math.floor(seconds / 60);
      const secs = seconds % 60;
      timerElement.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
      
      if (seconds <= 10) {
        timerElement.className = 'timer danger';
      } else if (seconds <= 20) {
        timerElement.className = 'timer warning';
      }
      
      if (seconds <= 0) {
        stopPractice();
      }
    }
    
    // Initialize application
    async function initializeApp() {
      try {
        updateApiStatus('checking', 'üîç Initializing Speech API...');
        compatibilityNotice.innerHTML = '<strong>‚è≥ Initializing speech recognition...</strong>';
        
        await initializeSpeechRecognition();
        
        // Success
        updateApiStatus('ready', '‚úÖ Speech API: Ready');
        compatibilityNotice.innerHTML = '<strong>‚úÖ Speech recognition is working!</strong>';
        compatibilityNotice.className = 'compatibility-notice success';
        startButton.disabled = false;
        
      } catch (error) {
        console.error('Initialization failed:', error);
        
        if (initializationAttempts < maxInitializationAttempts) {
          console.log(`Retrying initialization... (${initializationAttempts}/${maxInitializationAttempts})`);
          setTimeout(initializeApp, 2000);
          return;
        }
        
        // Failed after all attempts
        updateApiStatus('error', '‚ùå Speech API: Failed');
        compatibilityNotice.innerHTML = '<strong>‚ùå Speech recognition is not available.</strong><br>This may be due to browser restrictions or iframe limitations.';
        compatibilityNotice.className = 'compatibility-notice error';
        showTroubleshooting();
      }
    }
    
    // Event listeners
    testButton.addEventListener('click', testSpeechRecognition);
    startButton.addEventListener('click', startPractice);
    stopButton.addEventListener('click', stopPractice);
    
    // Initialize when page loads
    window.addEventListener('load', function() {
      console.log('Page loaded, starting initialization...');
      
      // Small delay to ensure everything is loaded
      setTimeout(initializeApp, 500);
    });
    
    // Additional iframe detection and handling
    if (window.self !== window.top) {
      console.log('Running in iframe - adding special handling');
      
      // Add message to parent window (if needed)
      try {
        window.parent.postMessage('speech-api-ready', '*');
      } catch (e) {
        // Ignore cross-origin errors
      }
    }
  </script>
</body>
</html>
