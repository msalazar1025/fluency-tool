<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fluency Practice with Audio Recording</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      background-color: #f5f5f5;
      padding: 20px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }
    
    .instructions {
      background-color: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 5px solid #2196F3;
    }
    
    .instructions h3 {
      margin-bottom: 10px;
      color: #1565C0;
    }
    
    .instructions ol {
      margin-left: 20px;
    }
    
    .controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    button {
      padding: 12px 30px;
      font-size: 18px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      color: white;
      background-color: #4CAF50;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: #45a049;
    }
    
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .stop-btn {
      background-color: #f44336;
    }
    
    .stop-btn:hover {
      background-color: #d32f2f;
    }
    
    .download-btn {
      background-color: #2196F3;
    }
    
    .download-btn:hover {
      background-color: #1976D2;
    }
    
    #timer {
      font-size: 72px;
      font-weight: bold;
      text-align: center;
      margin: 20px 0;
      color: #333;
    }
    
    .timer.warning {
      color: #ff9800;
    }
    
    .timer.danger {
      color: #f44336;
    }
    
    .status-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .status-box {
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
    }
    
    .recording-status {
      background-color: #ffebee;
      color: #c62828;
    }
    
    .recording-status.active {
      background-color: #e8f5e9;
      color: #2e7d32;
      animation: pulse 1.5s infinite;
    }
    
    .speech-status {
      background-color: #f3e5f5;
      color: #7b1fa2;
    }
    
    .speech-status.listening {
      background-color: #e3f2fd;
      color: #1565c0;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .audio-controls {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
    }
    
    .audio-controls h4 {
      margin-bottom: 15px;
      color: #333;
    }
    
    audio {
      width: 100%;
      max-width: 400px;
      margin: 10px 0;
    }
    
    .waveform {
      width: 100%;
      height: 60px;
      background-color: #e0e0e0;
      border-radius: 5px;
      margin: 10px 0;
      position: relative;
      overflow: hidden;
    }
    
    .wave-bar {
      position: absolute;
      bottom: 0;
      width: 2px;
      background-color: #4CAF50;
      transition: height 0.1s;
    }
    
    #speechText {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
      min-height: 80px;
      font-style: italic;
      border: 1px dashed #ccc;
      max-height: 150px;
      overflow-y: auto;
    }
    
    .passage {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      line-height: 1.8;
      font-size: 18px;
    }
    
    .passage h3 {
      margin-bottom: 15px;
      color: #333;
    }
    
    .passage p {
      margin-bottom: 15px;
      text-indent: 2em;
    }
    
    .results {
      background-color: #e8f4f8;
      padding: 25px;
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }
    
    .results.active {
      display: block;
    }
    
    .results h3 {
      margin-bottom: 20px;
      color: #333;
      text-align: center;
    }
    
    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .result-box {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .result-label {
      font-weight: bold;
      color: #666;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    .result-value {
      font-size: 32px;
      font-weight: bold;
      color: #2196F3;
    }
    
    .accuracy-analysis {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }
    
    .accuracy-analysis h4 {
      margin-bottom: 15px;
      color: #333;
    }
    
    .word-comparison {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }
    
    .word {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .word-correct {
      background-color: #c8e6c9;
      color: #1b5e20;
    }
    
    .word-incorrect {
      background-color: #ffcdd2;
      color: #b71c1c;
    }
    
    .word-missed {
      background-color: #fff9c4;
      color: #f57f17;
    }
    
    .recording-info {
      background-color: #fff3e0;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #ff9800;
    }
    
    .recording-info h4 {
      color: #e65100;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🎤🔊 Fluency Practice with Audio Recording</h1>
    
    <div class="instructions">
      <h3>Instructions:</h3>
      <ol>
        <li>Click "START RECORDING" to begin both timer and audio recording</li>
        <li>Allow microphone access when prompted</li>
        <li>Read the passage aloud clearly for 60 seconds</li>
        <li>View your speech analysis and download the recording when finished</li>
      </ol>
    </div>
    
    <div class="controls">
      <button id="startButton">START RECORDING</button>
      <button id="stopButton" class="stop-btn" style="display: none;">STOP</button>
      <button id="downloadButton" class="download-btn" style="display: none;">DOWNLOAD AUDIO</button>
    </div>
    
    <div id="timer">1:00</div>
    
    <div class="status-panel">
      <div class="status-box recording-status" id="recordingStatus">
        🔴 Recording: Stopped
      </div>
      <div class="status-box speech-status" id="speechStatus">
        🎤 Speech Recognition: Ready
      </div>
    </div>
    
    <div class="recording-info">
      <h4>📊 Live Audio Visualization</h4>
      <div class="waveform" id="waveform"></div>
    </div>
    
    <div id="speechText">Speech recognition text will appear here...</div>
    
    <div class="passage">
      <h3>An Unusual Burglar</h3>
      <p>Theft is a serious crime. If someone stole something from you, you would most likely not be too forgiving. You would probably be very upset if the stealing continued for years. There is a place in California where thefts take place nightly. Strangely, though, most people there just laugh when their items disappear. That is because the culprit is a cat.</p>
      
      <p>Jean Chu and her family adopted Dusty, their pet cat, a few years ago. Not long after he moved in, the family members started finding odd objects lying around. One day they would find a glove and an unfamiliar towel. The next day there would be a pot holder and a sock. At first no one knew what to think about the items that mysteriously appeared on the porch or in the yard. Soon they realized that the objects always showed up in the morning. And which member of the family tended to roam every night? That would be Dusty.</p>
    </div>
    
    <div class="audio-controls" id="audioControls" style="display: none;">
      <h4>🎧 Recorded Audio</h4>
      <audio id="audioPlayback" controls></audio>
      <p>You can listen to your recording and download it using the button above.</p>
    </div>
    
    <div class="results" id="results">
      <h3>📈 Your Reading Analysis</h3>
      
      <div class="result-grid">
        <div class="result-box">
          <div class="result-label">Total Words Spoken</div>
          <div id="totalWords" class="result-value">0</div>
        </div>
        <div class="result-box">
          <div class="result-label">Correct Words</div>
          <div id="correctWords" class="result-value">0</div>
        </div>
        <div class="result-box">
          <div class="result-label">Reading Speed</div>
          <div id="wpm" class="result-value">0</div>
          <div class="result-label" style="font-size: 12px;">words per minute</div>
        </div>
        <div class="result-box">
          <div class="result-label">Accuracy</div>
          <div id="accuracy" class="result-value">0%</div>
        </div>
      </div>
      
      <div class="accuracy-analysis">
        <h4>Word-by-Word Analysis</h4>
        <p><span style="background-color: #c8e6c9; padding: 2px 6px; border-radius: 3px;">Green = Correct</span> 
           <span style="background-color: #ffcdd2; padding: 2px 6px; border-radius: 3px;">Red = Incorrect</span> 
           <span style="background-color: #fff9c4; padding: 2px 6px; border-radius: 3px;">Yellow = Missed</span></p>
        <div class="word-comparison" id="wordComparison"></div>
      </div>
    </div>
  </div>
  
  <script>
    // Global variables
    let timer;
    let seconds = 60;
    let isRunning = false;
    let recognition;
    let mediaRecorder;
    let recordedChunks = [];
    let audioContext;
    let analyser;
    let microphone;
    let wordCount = 0;
    let spokenWords = [];
    let transcriptText = '';
    let passageWords = [];
    
    // DOM elements
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const downloadButton = document.getElementById('downloadButton');
    const timerElement = document.getElementById('timer');
    const recordingStatus = document.getElementById('recordingStatus');
    const speechStatus = document.getElementById('speechStatus');
    const speechText = document.getElementById('speechText');
    const results = document.getElementById('results');
    const audioControls = document.getElementById('audioControls');
    const audioPlayback = document.getElementById('audioPlayback');
    const waveform = document.getElementById('waveform');
    
    // Initialize passage words for comparison
    function initializePassageWords() {
      const passageText = document.querySelector('.passage').innerText;
      passageWords = passageText
        .toLowerCase()
        .replace(/[.,!?;:]/g, '')
        .split(/\s+/)
        .filter(word => word.length > 0);
    }
    
    // Set up event listeners
    startButton.addEventListener('click', startRecording);
    stopButton.addEventListener('click', stopRecording);
    downloadButton.addEventListener('click', downloadAudio);
    
    // Initialize audio visualization
    function createWaveform() {
      waveform.innerHTML = '';
      for (let i = 0; i < 100; i++) {
        const bar = document.createElement('div');
        bar.className = 'wave-bar';
        bar.style.left = `${i * 2}px`;
        bar.style.height = '2px';
        waveform.appendChild(bar);
      }
    }
    
    // Update waveform visualization
    function updateWaveform() {
      if (!analyser) return;
      
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      analyser.getByteFrequencyData(dataArray);
      
      const bars = waveform.querySelectorAll('.wave-bar');
      const step = Math.floor(bufferLength / bars.length);
      
      for (let i = 0; i < bars.length; i++) {
        const value = dataArray[i * step];
        const height = (value / 255) * 60;
        bars[i].style.height = `${Math.max(2, height)}px`;
      }
      
      if (isRunning) {
        requestAnimationFrame(updateWaveform);
      }
    }
    
    // Initialize speech recognition
    function initSpeechRecognition() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';
        
        recognition.onstart = function() {
          speechStatus.textContent = '🎤 Speech Recognition: Listening...';
          speechStatus.className = 'status-box speech-status listening';
        };
        
        recognition.onresult = function(event) {
          let interimTranscript = '';
          let finalTranscript = '';
          
          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              finalTranscript += transcript + ' ';
            } else {
              interimTranscript += transcript;
            }
          }
          
          if (finalTranscript) {
            transcriptText += finalTranscript;
            const words = finalTranscript
              .toLowerCase()
              .replace(/[.,!?;:]/g, '')
              .trim()
              .split(/\s+/)
              .filter(word => word.length > 0);
            spokenWords = spokenWords.concat(words);
            wordCount = spokenWords.length;
          }
          
          speechText.textContent = transcriptText + interimTranscript;
        };
        
        recognition.onerror = function(event) {
          console.error('Speech recognition error:', event.error);
          speechStatus.textContent = '❌ Speech Error: ' + event.error;
          speechStatus.className = 'status-box speech-status';
        };
        
        recognition.onend = function() {
          if (isRunning) {
            try {
              recognition.start();
            } catch (e) {
              console.error('Error restarting recognition:', e);
            }
          } else {
            speechStatus.textContent = '🎤 Speech Recognition: Stopped';
            speechStatus.className = 'status-box speech-status';
          }
        };
        
        return true;
      }
      
      alert('Speech recognition is not supported in your browser. Please use Chrome or Edge.');
      return false;
    }
    
    // Start recording
    async function startRecording() {
      if (isRunning) return;
      
      try {
        // Get microphone access
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            sampleRate: 44100
          } 
        });
        
        // Set up audio recording
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
        
        mediaRecorder.ondataavailable = function(event) {
          if (event.data.size > 0) {
            recordedChunks.push(event.data);
          }
        };
        
        mediaRecorder.onstop = function() {
          const blob = new Blob(recordedChunks, { type: 'audio/webm;codecs=opus' });
          const audioURL = URL.createObjectURL(blob);
          audioPlayback.src = audioURL;
          audioControls.style.display = 'block';
          downloadButton.style.display = 'inline-block';
          
          // Store blob for download
          downloadButton.onclick = function() {
            const link = document.createElement('a');
            link.href = audioURL;
            link.download = `fluency-practice-${new Date().toISOString().slice(0,19)}.webm`;
            link.click();
          };
        };
        
        // Set up audio visualization
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        microphone = audioContext.createMediaStreamSource(stream);
        microphone.connect(analyser);
        
        analyser.fftSize = 256;
        
        // Initialize speech recognition
        if (!recognition) {
          if (!initSpeechRecognition()) {
            return;
          }
        }
        
        // Reset values
        wordCount = 0;
        spokenWords = [];
        transcriptText = '';
        seconds = 60;
        isRunning = true;
        
        // Update UI
        startButton.style.display = 'none';
        stopButton.style.display = 'inline-block';
        results.classList.remove('active');
        speechText.textContent = 'Start reading...';
        audioControls.style.display = 'none';
        downloadButton.style.display = 'none';
        
        // Start recording and recognition
        mediaRecorder.start();
        recordingStatus.textContent = '🔴 Recording: Active';
        recordingStatus.className = 'status-box recording-status active';
        
        recognition.start();
        
        // Start timer and visualization
        timer = setInterval(updateTimer, 1000);
        updateWaveform();
        
      } catch (error) {
        console.error('Error starting recording:', error);
        alert('Could not access microphone. Please check permissions and try again.');
      }
    }
    
    // Update timer
    function updateTimer() {
      seconds--;
      
      const minutes = Math.floor(seconds / 60);
      const secs = seconds % 60;
      timerElement.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
      
      // Change color based on time remaining
      if (seconds <= 10) {
        timerElement.className = 'timer danger';
      } else if (seconds <= 20) {
        timerElement.className = 'timer warning';
      }
      
      // Time's up!
      if (seconds <= 0) {
        stopRecording();
      }
    }
    
    // Stop recording
    function stopRecording() {
      if (!isRunning) return;
      
      clearInterval(timer);
      isRunning = false;
      
      // Stop recording
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
      }
      
      // Stop speech recognition
      if (recognition) {
        recognition.stop();
      }
      
      // Stop audio context
      if (audioContext) {
        audioContext.close();
      }
      
      // Calculate and display results
      calculateResults();
      
      // Update UI
      startButton.style.display = 'inline-block';
      stopButton.style.display = 'none';
      recordingStatus.textContent = '🔴 Recording: Stopped';
      recordingStatus.className = 'status-box recording-status';
      
      // Reset timer display
      timerElement.textContent = '1:00';
      timerElement.className = 'timer';
    }
    
    // Calculate results and accuracy
    function calculateResults() {
      let correct = 0;
      let incorrect = 0;
      const analysis = [];
      
      // Compare spoken words to passage words
      for (let i = 0; i < Math.max(spokenWords.length, passageWords.length); i++) {
        if (i < spokenWords.length && i < passageWords.length) {
          if (spokenWords[i] === passageWords[i]) {
            correct++;
            analysis.push({ word: spokenWords[i], status: 'correct' });
          } else {
            incorrect++;
            analysis.push({ 
              word: spokenWords[i], 
              expected: passageWords[i], 
              status: 'incorrect' 
            });
          }
        } else if (i < passageWords.length) {
          analysis.push({ word: passageWords[i], status: 'missed' });
        }
      }
      
      const totalWords = spokenWords.length;
      const accuracy = totalWords > 0 ? Math.round((correct / totalWords) * 100) : 0;
      const timeTaken = 60 - seconds;
      const wpm = Math.round((totalWords / timeTaken) * 60);
      
      // Update results display
      document.getElementById('totalWords').textContent = totalWords;
      document.getElementById('correctWords').textContent = correct;
      document.getElementById('wpm').textContent = wpm;
      document.getElementById('accuracy').textContent = accuracy + '%';
      
      // Display word comparison
      displayWordComparison(analysis);
      
      // Show results
      results.classList.add('active');
    }
    
    // Display word-by-word comparison
    function displayWordComparison(analysis) {
      const container = document.getElementById('wordComparison');
      container.innerHTML = '';
      
      const sampleSize = Math.min(50, analysis.length);
      for (let i = 0; i < sampleSize; i++) {
        const item = analysis[i];
        const span = document.createElement('span');
        span.className = 'word word-' + item.status;
        
        if (item.status === 'incorrect') {
          span.textContent = `${item.word}→${item.expected}`;
          span.title = `You said "${item.word}" but expected "${item.expected}"`;
        } else {
          span.textContent = item.word;
        }
        
        container.appendChild(span);
      }
      
      if (analysis.length > sampleSize) {
        const more = document.createElement('span');
        more.textContent = `... and ${analysis.length - sampleSize} more words`;
        more.style.fontStyle = 'italic';
        more.style.color = '#666';
        container.appendChild(more);
      }
    }
    
    // Initialize on page load
    window.addEventListener('load', function() {
      initializePassageWords();
      createWaveform();
      
      // Check for browser support
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('Audio recording is not supported in your browser. Please use Chrome or Edge.');
      }
    });
  </script>
</body>
</html>
