<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fluency Practice with Error Analysis</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      background-color: #f5f5f5;
      padding: 10px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      text-align: center;
      margin-bottom: 15px;
      color: #333;
      font-size: 1.8em;
    }
    
    .instructions {
      background-color: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 5px solid #2196F3;
    }
    
    .instructions h3 {
      margin-bottom: 10px;
      color: #1565C0;
    }
    
    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    button {
      padding: 12px 25px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      color: white;
      background-color: #4CAF50;
      transition: background-color 0.3s;
    }
    
    button:hover:not(:disabled) {
      background-color: #45a049;
    }
    
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .stop-btn {
      background-color: #f44336;
    }
    
    .stop-btn:hover:not(:disabled) {
      background-color: #d32f2f;
    }
    
    .test-btn {
      background-color: #ff9800;
    }
    
    .test-btn:hover:not(:disabled) {
      background-color: #f57c00;
    }
    
    #timer {
      font-size: 64px;
      font-weight: bold;
      text-align: center;
      margin: 20px 0;
      color: #333;
    }
    
    .timer.warning {
      color: #ff9800;
    }
    
    .timer.danger {
      color: #f44336;
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .status-box {
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      font-size: 14px;
    }
    
    .api-status {
      background-color: #fff3e0;
      color: #e65100;
    }
    
    .api-status.ready {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    
    .api-status.error {
      background-color: #ffebee;
      color: #c62828;
    }
    
    .session-status {
      background-color: #f3e5f5;
      color: #7b1fa2;
    }
    
    .session-status.active {
      background-color: #e8f5e9;
      color: #2e7d32;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    #speechText {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
      min-height: 60px;
      font-style: italic;
      border: 2px dashed #4caf50;
      max-height: 120px;
      overflow-y: auto;
      font-size: 14px;
    }
    
    .passage {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      line-height: 1.8;
      font-size: 16px;
    }
    
    .passage h3 {
      margin-bottom: 15px;
      color: #333;
    }
    
    .passage p {
      margin-bottom: 15px;
      text-indent: 2em;
    }
    
    .results {
      background-color: #e8f4f8;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }
    
    .results.active {
      display: block;
    }
    
    .results h3 {
      margin-bottom: 15px;
      color: #333;
      text-align: center;
    }
    
    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .result-box {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .result-label {
      font-weight: bold;
      color: #666;
      margin-bottom: 8px;
      font-size: 12px;
    }
    
    .result-value {
      font-size: 28px;
      font-weight: bold;
      color: #2196F3;
    }
    
    .error-analysis {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      border: 2px solid #f44336;
    }
    
    .error-analysis h4 {
      color: #c62828;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .error-list {
      margin: 15px 0;
    }
    
    .error-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background-color: #ffebee;
      border-radius: 5px;
      border-left: 4px solid #f44336;
    }
    
    .error-spoken {
      font-weight: bold;
      color: #c62828;
    }
    
    .error-expected {
      font-weight: bold;
      color: #2e7d32;
    }
    
    .error-arrow {
      margin: 0 10px;
      color: #666;
      font-size: 18px;
    }
    
    .error-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }
    
    .error-stat {
      background-color: #fff3e0;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
    }
    
    .error-stat-label {
      font-size: 12px;
      color: #e65100;
      font-weight: bold;
    }
    
    .error-stat-value {
      font-size: 20px;
      font-weight: bold;
      color: #f57c00;
    }
    
    .word-comparison {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }
    
    .word-comparison h4 {
      margin-bottom: 15px;
      color: #333;
    }
    
    .word {
      display: inline-block;
      padding: 4px 8px;
      margin: 2px;
      border-radius: 4px;
      font-size: 14px;
      position: relative;
      cursor: pointer;
    }
    
    .word-correct {
      background-color: #c8e6c9;
      color: #1b5e20;
    }
    
    .word-incorrect {
      background-color: #ffcdd2;
      color: #b71c1c;
      border: 2px solid #f44336;
    }
    
    .word-missed {
      background-color: #fff9c4;
      color: #f57f17;
    }
    
    .word-incorrect:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
    }
    
    .summary-section {
      background-color: #f0f8ff;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      border: 2px solid #2196F3;
    }
    
    .summary-section h4 {
      color: #1565c0;
      margin-bottom: 15px;
    }
    
    .improvement-tips {
      background-color: #e8f5e9;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }
    
    .improvement-tips h5 {
      color: #2e7d32;
      margin-bottom: 10px;
    }
    
    .improvement-tips ul {
      margin-left: 20px;
    }
    
    .improvement-tips li {
      margin-bottom: 5px;
      color: #1b5e20;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ Fluency Practice with Error Analysis</h1>
    
    <div class="instructions">
      <h3>Instructions:</h3>
      <ol>
        <li>Click "Test Speech Recognition" first to verify it works</li>
        <li>Click "Start Practice" to begin the 60-second session</li>
        <li>Read the passage aloud clearly</li>
        <li>Review your detailed error analysis when finished</li>
      </ol>
    </div>
    
    <div class="controls">
      <button id="testButton" class="test-btn">Test Speech Recognition</button>
      <button id="startButton" disabled>Start Practice</button>
      <button id="stopButton" class="stop-btn" style="display: none;">Stop</button>
    </div>
    
    <div id="timer">1:00</div>
    
    <div class="status-grid">
      <div class="status-box api-status" id="apiStatus">
        üîç Checking Speech API...
      </div>
      <div class="status-box session-status" id="sessionStatus">
        üìä Session: Ready
      </div>
    </div>
    
    <div id="speechText">
      Speech recognition output will appear here...
    </div>
    
    <div class="passage">
      <h3>An Unusual Burglar</h3>
      <p>Theft is a serious crime. If someone stole something from you, you would most likely not be too forgiving. You would probably be very upset if the stealing continued for years. There is a place in California where thefts take place nightly. Strangely, though, most people there just laugh when their items disappear. That is because the culprit is a cat.</p>
      
      <p>Jean Chu and her family adopted Dusty, their pet cat, a few years ago. Not long after he moved in, the family members started finding odd objects lying around. One day they would find a glove and an unfamiliar towel. The next day there would be a pot holder and a sock. At first no one knew what to think about the items that mysteriously appeared on the porch or in the yard. Soon they realized that the objects always showed up in the morning. And which member of the family tended to roam every night? That would be Dusty.</p>
    </div>
    
    <div class="results" id="results">
      <h3>üìà Your Reading Analysis</h3>
      
      <div class="result-grid">
        <div class="result-box">
          <div class="result-label">Words Spoken</div>
          <div id="totalWords" class="result-value">0</div>
        </div>
        <div class="result-box">
          <div class="result-label">Correct Words</div>
          <div id="correctWords" class="result-value">0</div>
        </div>
        <div class="result-box">
          <div class="result-label">Incorrect Words</div>
          <div id="incorrectWords" class="result-value">0</div>
        </div>
        <div class="result-box">
          <div class="result-label">Reading Speed</div>
          <div id="wpm" class="result-value">0</div>
          <div class="result-label" style="font-size: 10px;">words/minute</div>
        </div>
        <div class="result-box">
          <div class="result-label">Accuracy</div>
          <div id="accuracy" class="result-value">0%</div>
        </div>
      </div>
      
      <div class="error-analysis" id="errorAnalysis">
        <h4>‚ùå Incorrectly Spoken Words</h4>
        
        <div class="error-stats" id="errorStats">
          <div class="error-stat">
            <div class="error-stat-label">Total Errors</div>
            <div class="error-stat-value" id="totalErrors">0</div>
          </div>
          <div class="error-stat">
            <div class="error-stat-label">Substitutions</div>
            <div class="error-stat-value" id="substitutions">0</div>
          </div>
          <div class="error-stat">
            <div class="error-stat-label">Omissions</div>
            <div class="error-stat-value" id="omissions">0</div>
          </div>
          <div class="error-stat">
            <div class="error-stat-label">Error Rate</div>
            <div class="error-stat-value" id="errorRate">0%</div>
          </div>
        </div>
        
        <div class="error-list" id="errorList">
          <!-- Error items will be populated here -->
        </div>
      </div>
      
      <div class="word-comparison">
        <h4>üéØ Word-by-Word Analysis</h4>
        <p><span style="background-color: #c8e6c9; padding: 2px 6px; border-radius: 3px;">Green = Correct</span> 
           <span style="background-color: #ffcdd2; padding: 2px 6px; border-radius: 3px;">Red = Incorrect (hover for details)</span> 
           <span style="background-color: #fff9c4; padding: 2px 6px; border-radius: 3px;">Yellow = Missed</span></p>
        <div id="wordComparison"></div>
      </div>
      
      <div class="summary-section">
        <h4>üìä Reading Summary</h4>
        <p id="readingSummary"></p>
        
        <div class="improvement-tips" id="improvementTips">
          <h5>üí° Tips for Improvement:</h5>
          <ul id="tipsList"></ul>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Global variables
    let speechRecognition = null;
    let isListening = false;
    let timer = null;
    let seconds = 60;
    let isRunning = false;
    let spokenWords = [];
    let transcriptText = '';
    let passageWords = [];
    let errorDetails = [];
    
    // DOM elements
    const testButton = document.getElementById('testButton');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const timerElement = document.getElementById('timer');
    const apiStatus = document.getElementById('apiStatus');
    const sessionStatus = document.getElementById('sessionStatus');
    const speechText = document.getElementById('speechText');
    const results = document.getElementById('results');
    
    // Initialize passage words
    function initializePassageWords() {
      const passageText = document.querySelector('.passage').innerText;
      passageWords = passageText
        .toLowerCase()
        .replace(/[.,!?;:]/g, '')
        .split(/\s+/)
        .filter(word => word.length > 0);
      console.log(`Loaded ${passageWords.length} words from passage`);
    }
    
    // Initialize speech recognition
    function initializeSpeechRecognition() {
      return new Promise((resolve, reject) => {
        if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
          reject('Speech Recognition not supported');
          return;
        }
        
        try {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          speechRecognition = new SpeechRecognition();
          
          speechRecognition.continuous = true;
          speechRecognition.interimResults = true;
          speechRecognition.lang = 'en-US';
          speechRecognition.maxAlternatives = 1;
          
          speechRecognition.onstart = function() {
            isListening = true;
            apiStatus.textContent = '‚úÖ Speech API: Listening';
            apiStatus.className = 'status-box api-status ready';
          };
          
          speechRecognition.onresult = function(event) {
            let interimTranscript = '';
            let finalTranscript = '';
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
              const transcript = event.results[i][0].transcript;
              if (event.results[i].isFinal) {
                finalTranscript += transcript + ' ';
              } else {
                interimTranscript += transcript;
              }
            }
            
            if (finalTranscript) {
              transcriptText += finalTranscript;
              const words = finalTranscript
                .toLowerCase()
                .replace(/[.,!?;:]/g, '')
                .trim()
                .split(/\s+/)
                .filter(word => word.length > 0);
              
              spokenWords = spokenWords.concat(words);
            }
            
            speechText.textContent = transcriptText + interimTranscript;
          };
          
          speechRecognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            isListening = false;
            
            if (event.error === 'not-allowed') {
              apiStatus.textContent = '‚ùå Microphone Access Denied';
              apiStatus.className = 'status-box api-status error';
            } else if (event.error !== 'no-speech') {
              apiStatus.textContent = `‚ùå Error: ${event.error}`;
              apiStatus.className = 'status-box api-status error';
            }
          };
          
          speechRecognition.onend = function() {
            isListening = false;
            
            if (isRunning) {
              setTimeout(() => {
                if (isRunning && speechRecognition) {
                  try {
                    speechRecognition.start();
                  } catch (e) {
                    console.error('Error restarting recognition:', e);
                  }
                }
              }, 100);
            } else {
              apiStatus.textContent = '‚úÖ Speech API: Ready';
              apiStatus.className = 'status-box api-status ready';
            }
          };
          
          // Test initialization
          speechRecognition.start();
          setTimeout(() => {
            if (speechRecognition && isListening) {
              speechRecognition.stop();
              resolve(true);
            }
          }, 500);
          
        } catch (error) {
          reject(error.message);
        }
      });
    }
    
    // Test speech recognition
    function testSpeechRecognition() {
      if (!speechRecognition) {
        alert('Speech recognition not initialized. Please refresh the page.');
        return;
      }
      
      apiStatus.textContent = 'üß™ Testing...';
      speechText.textContent = 'Testing speech recognition... Say something!';
      
      try {
        speechRecognition.start();
        setTimeout(() => {
          if (isListening && !isRunning) {
            speechRecognition.stop();
            apiStatus.textContent = '‚úÖ Test Complete';
          }
        }, 5000);
      } catch (error) {
        console.error('Test failed:', error);
        apiStatus.textContent = '‚ùå Test Failed';
      }
    }
    
    // Start practice session
    function startPractice() {
      if (isRunning || !speechRecognition) return;
      
      // Reset session
      spokenWords = [];
      transcriptText = '';
      errorDetails = [];
      seconds = 60;
      isRunning = true;
      
      // Update UI
      startButton.style.display = 'none';
      stopButton.style.display = 'inline-block';
      results.classList.remove('active');
      speechText.textContent = 'Start reading the passage aloud...';
      sessionStatus.textContent = 'üìä Session: Active';
      sessionStatus.className = 'status-box session-status active';
      
      // Start speech recognition
      try {
        speechRecognition.start();
      } catch (error) {
        console.error('Failed to start recognition:', error);
        if (error.name === 'InvalidStateError') {
          speechRecognition.stop();
          setTimeout(() => {
            try {
              speechRecognition.start();
            } catch (e) {
              console.error('Restart failed:', e);
            }
          }, 100);
        }
      }
      
      // Start timer
      timer = setInterval(updateTimer, 1000);
    }
    
    // Stop practice session
    function stopPractice() {
      if (!isRunning) return;
      
      clearInterval(timer);
      isRunning = false;
      
      if (speechRecognition && isListening) {
        speechRecognition.stop();
      }
      
      // Calculate results with detailed error analysis
      calculateDetailedResults();
      
      // Update UI
      startButton.style.display = 'inline-block';
      stopButton.style.display = 'none';
      sessionStatus.textContent = 'üìä Session: Complete';
      sessionStatus.className = 'status-box session-status';
      
      // Reset timer
      timerElement.textContent = '1:00';
      timerElement.className = '';
    }
    
    // Update timer
    function updateTimer() {
      seconds--;
      
      const minutes = Math.floor(seconds / 60);
      const secs = seconds % 60;
      timerElement.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
      
      if (seconds <= 10) {
        timerElement.className = 'timer danger';
      } else if (seconds <= 20) {
        timerElement.className = 'timer warning';
      }
      
      if (seconds <= 0) {
        stopPractice();
      }
    }
    
    // Calculate detailed results with error analysis
    function calculateDetailedResults() {
      let correct = 0;
      let incorrect = 0;
      let substitutions = 0;
      let omissions = 0;
      const analysis = [];
      errorDetails = [];
      
      // Compare spoken words to passage words
      for (let i = 0; i < Math.max(spokenWords.length, passageWords.length); i++) {
        if (i < spokenWords.length && i < passageWords.length) {
          if (spokenWords[i] === passageWords[i]) {
            correct++;
            analysis.push({ word: spokenWords[i], status: 'correct' });
          } else {
            incorrect++;
            substitutions++;
            analysis.push({ 
              word: spokenWords[i], 
              expected: passageWords[i], 
              status: 'incorrect' 
            });
            
            // Add to error details
            errorDetails.push({
              type: 'substitution',
              spoken: spokenWords[i],
              expected: passageWords[i],
              position: i + 1
            });
          }
        } else if (i < passageWords.length) {
          // Word was omitted
          omissions++;
          analysis.push({ word: passageWords[i], status: 'missed' });
          
          errorDetails.push({
            type: 'omission',
            expected: passageWords[i],
            position: i + 1
          });
        }
      }
      
      const totalWords = spokenWords.length;
      const accuracy = totalWords > 0 ? Math.round((correct / totalWords) * 100) : 0;
      const errorRate = totalWords > 0 ? Math.round(((incorrect + omissions) / totalWords) * 100) : 0;
      const timeTaken = 60 - seconds;
      const wpm = Math.round((totalWords / timeTaken) * 60);
      
      // Update basic results
      document.getElementById('totalWords').textContent = totalWords;
      document.getElementById('correctWords').textContent = correct;
      document.getElementById('incorrectWords').textContent = incorrect;
      document.getElementById('wpm').textContent = wpm;
      document.getElementById('accuracy').textContent = accuracy + '%';
      
      // Update error statistics
      document.getElementById('totalErrors').textContent = incorrect + omissions;
      document.getElementById('substitutions').textContent = substitutions;
      document.getElementById('omissions').textContent = omissions;
      document.getElementById('errorRate').textContent = errorRate + '%';
      
      // Display detailed error list
      displayErrorList();
      
      // Display word comparison
      displayWordComparison(analysis);
      
      // Generate reading summary and tips
      generateReadingSummary(accuracy, wpm, errorRate);
      
      // Show results
      results.classList.add('active');
    }
    
    // Display detailed error list
    function displayErrorList() {
      const errorList = document.getElementById('errorList');
      errorList.innerHTML = '';
      
      if (errorDetails.length === 0) {
        errorList.innerHTML = '<p style="color: #2e7d32; font-style: italic;">üéâ No errors detected! Great job!</p>';
        return;
      }
      
      errorDetails.forEach((error, index) => {
        const errorItem = document.createElement('div');
        errorItem.className = 'error-item';
        
        if (error.type === 'substitution') {
          errorItem.innerHTML = `
            <span class="error-spoken">"${error.spoken}"</span>
            <span class="error-arrow">‚Üí</span>
            <span class="error-expected">"${error.expected}"</span>
            <small style="color: #666;">(Position ${error.position})</small>
          `;
        } else if (error.type === 'omission') {
          errorItem.innerHTML = `
            <span class="error-spoken">SKIPPED</span>
            <span class="error-arrow">‚Üí</span>
            <span class="error-expected">"${error.expected}"</span>
            <small style="color: #666;">(Position ${error.position})</small>
          `;
        }
        
        errorList.appendChild(errorItem);
      });
    }
    
    // Display word comparison with tooltips
    function displayWordComparison(analysis) {
      const container = document.getElementById('wordComparison');
      container.innerHTML = '';
      
      const sampleSize = Math.min(100, analysis.length);
      for (let i = 0; i < sampleSize; i++) {
        const item = analysis[i];
        const span = document.createElement('span');
        span.className = 'word word-' + item.status;
        
        if (item.status === 'incorrect') {
          span.textContent = item.word;
          span.setAttribute('data-tooltip', `Expected: "${item.expected}"`);
        } else {
          span.textContent = item.word;
        }
        
        container.appendChild(span);
      }
      
      if (analysis.length > sampleSize) {
        const more = document.createElement('span');
        more.textContent = `... and ${analysis.length - sampleSize} more words`;
        more.style.fontStyle = 'italic';
        more.style.color = '#666';
        container.appendChild(more);
      }
    }
    
    // Generate reading summary and improvement tips
    function generateReadingSummary(accuracy, wpm, errorRate) {
      const summaryElement = document.getElementById('readingSummary');
      const tipsElement = document.getElementById('tipsList');
      
      // Generate summary
      let summary = '';
      if (accuracy >= 95) {
        summary = 'üåü Excellent reading! Your accuracy is outstanding.';
      } else if (accuracy >= 85) {
        summary = 'üëç Good reading! Your accuracy is solid with room for minor improvements.';
      } else if (accuracy >= 70) {
        summary = 'üìö Developing reader. Focus on accuracy while maintaining pace.';
      } else {
        summary = 'üéØ Keep practicing! Focus on reading each word carefully.';
      }
      
      if (wpm >= 150) {
        summary += ' Your reading speed is excellent.';
      } else if (wpm >= 120) {
        summary += ' Your reading speed is good.';
      } else if (wpm >= 90) {
        summary += ' Your reading speed is developing well.';
      } else {
        summary += ' Work on building your reading speed gradually.';
      }
      
      summaryElement.textContent = summary;
      
      // Generate tips
      tipsElement.innerHTML = '';
      const tips = [];
      
      if (accuracy < 90) {
        tips.push('Practice reading slowly and carefully to pronounce the words.'); }
        else { tips.push('Great job!'); }
