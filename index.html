<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fluency Practice - Fixed Version</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      background-color: #f5f5f5;
      padding: 15px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }
    
    .instructions {
      background-color: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 5px solid #2196F3;
    }
    
    .controls {
      text-align: center;
      margin: 25px 0;
    }
    
    button {
      padding: 12px 30px;
      margin: 10px;
      font-size: 18px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      color: white;
      background-color: #4CAF50;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: #45a049;
    }
    
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .stop-btn {
      background-color: #f44336;
    }
    
    .stop-btn:hover {
      background-color: #d32f2f;
    }
    
    .test-btn {
      background-color: #ff9800;
    }
    
    .test-btn:hover {
      background-color: #f57c00;
    }
    
    #timer {
      font-size: 72px;
      font-weight: bold;
      text-align: center;
      margin: 25px 0;
      color: #333;
    }
    
    .timer.warning {
      color: #ff9800;
    }
    
    .timer.danger {
      color: #f44336;
    }
    
    .status {
      text-align: center;
      padding: 15px;
      margin: 20px 0;
      border-radius: 8px;
      font-weight: bold;
    }
    
    .status.ready {
      background-color: #d4edda;
      color: #155724;
    }
    
    .status.listening {
      background-color: #cce5ff;
      color: #004085;
      animation: pulse 1.5s infinite;
    }
    
    .status.error {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    #speechText {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
      min-height: 80px;
      border: 2px dashed #4caf50;
      max-height: 150px;
      overflow-y: auto;
    }
    
    .passage {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      line-height: 1.8;
      font-size: 18px;
    }
    
    .passage h3 {
      margin-bottom: 15px;
      color: #333;
    }
    
    .passage p {
      margin-bottom: 15px;
      text-indent: 2em;
    }
    
    .results {
      background-color: #e8f4f8;
      padding: 25px;
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }
    
    .results.active {
      display: block;
    }
    
    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .result-box {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .result-label {
      font-weight: bold;
      color: #666;
      margin-bottom: 10px;
    }
    
    .result-value {
      font-size: 36px;
      font-weight: bold;
      color: #2196F3;
    }
    
    .error-analysis {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      border: 2px solid #f44336;
    }
    
    .error-list {
      margin: 15px 0;
    }
    
    .error-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      margin: 8px 0;
      background-color: #ffebee;
      border-radius: 5px;
      border-left: 4px solid #f44336;
    }
    
    .error-spoken {
      font-weight: bold;
      color: #c62828;
    }
    
    .error-expected {
      font-weight: bold;
      color: #2e7d32;
    }
    
    .troubleshoot {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      display: none;
    }
    
    .troubleshoot.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ Fluency Practice with Error Analysis</h1>
    
    <div class="instructions">
      <h3>How to Use:</h3>
      <ol>
        <li>Click "Initialize Speech" to set up voice recognition</li>
        <li>If that works, click "Start Practice" to begin</li>
        <li>Read the passage aloud for 60 seconds</li>
        <li>See your detailed results and error analysis</li>
      </ol>
    </div>
    
    <div class="controls">
      <button id="initButton">Initialize Speech</button>
      <button id="testButton" class="test-btn" style="display: none;">Test Voice</button>
      <button id="startButton" style="display: none;">Start Practice</button>
      <button id="stopButton" class="stop-btn" style="display: none;">Stop</button>
    </div>
    
    <div id="timer">1:00</div>
    
    <div class="status ready" id="status">
      üé§ Click "Initialize Speech" to begin
    </div>
    
    <div class="troubleshoot" id="troubleshoot">
      <h4>üîß Troubleshooting:</h4>
      <ul>
        <li><strong>Use Chrome or Edge browser</strong> for best results</li>
        <li><strong>Allow microphone access</strong> when prompted</li>
        <li><strong>Check your microphone</strong> is working in other apps</li>
        <li><strong>Try refreshing the page</strong> if it's not working</li>
        <li><strong>Make sure you're on HTTPS</strong> (speech requires secure connection)</li>
      </ul>
    </div>
    
    <div id="speechText">
      Voice recognition results will appear here...
    </div>
    
    <div class="passage">
      <h3>An Unusual Burglar</h3>
      <p>Theft is a serious crime. If someone stole something from you, you would most likely not be too forgiving. You would probably be very upset if the stealing continued for years. There is a place in California where thefts take place nightly. Strangely, though, most people there just laugh when their items disappear. That is because the culprit is a cat.</p>
      
      <p>Jean Chu and her family adopted Dusty, their pet cat, a few years ago. Not long after he moved in, the family members started finding odd objects lying around. One day they would find a glove and an unfamiliar towel. The next day there would be a pot holder and a sock. At first no one knew what to think about the items that mysteriously appeared on the porch or in the yard. Soon they realized that the objects always showed up in the morning. And which member of the family tended to roam every night? That would be Dusty.</p>
    </div>
    
    <div class="results" id="results">
      <h3>üìà Your Reading Results</h3>
      
      <div class="result-grid">
        <div class="result-box">
          <div class="result-label">Words Spoken</div>
          <div id="totalWords" class="result-value">0</div>
        </div>
        <div class="result-box">
          <div class="result-label">Correct Words</div>
          <div id="correctWords" class="result-value">0</div>
        </div>
        <div class="result-box">
          <div class="result-label">Incorrect Words</div>
          <div id="incorrectWords" class="result-value">0</div>
        </div>
        <div class="result-box">
          <div class="result-label">Reading Speed</div>
          <div id="wpm" class="result-value">0</div>
          <div class="result-label">words per minute</div>
        </div>
        <div class="result-box">
          <div class="result-label">Accuracy</div>
          <div id="accuracy" class="result-value">0%</div>
        </div>
      </div>
      
      <div class="error-analysis" id="errorAnalysis">
        <h4>‚ùå Words That Need Practice</h4>
        <div class="error-list" id="errorList">
          <!-- Errors will be shown here -->
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Global variables
    let recognition = null;
    let isRunning = false;
    let isListening = false;
    let timer = null;
    let seconds = 60;
    let spokenWords = [];
    let transcriptText = '';
    let passageWords = [];
    let errorDetails = [];
    
    // Get passage words for comparison
    function loadPassageWords() {
      const passageText = document.querySelector('.passage').innerText
        .replace(/An Unusual Burglar/g, '')
        .toLowerCase()
        .replace(/[.,!?;:]/g, '')
        .split(/\s+/)
        .filter(word => word.length > 0);
      
      passageWords = passageText;
      console.log('Loaded passage:', passageWords.length, 'words');
    }
    
    // Initialize speech recognition
    function initializeSpeech() {
      const status = document.getElementById('status');
      const troubleshoot = document.getElementById('troubleshoot');
      
      status.textContent = 'üîÑ Setting up speech recognition...';
      status.className = 'status';
      
      // Check browser support
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        status.textContent = '‚ùå Speech recognition not supported in this browser';
        status.className = 'status error';
        troubleshoot.classList.add('show');
        return;
      }
      
      try {
        // Create recognition object
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        // Configure recognition
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';
        
        // Set up event handlers
        recognition.onstart = function() {
          console.log('Speech recognition started');
          isListening = true;
          status.textContent = 'üé§ Speech recognition is listening...';
          status.className = 'status listening';
        };
        
        recognition.onresult = function(event) {
          let interimTranscript = '';
          let finalTranscript = '';
          
          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              finalTranscript += transcript + ' ';
            } else {
              interimTranscript += transcript;
            }
          }
          
          if (finalTranscript) {
            transcriptText += finalTranscript;
            const words = finalTranscript
              .toLowerCase()
              .replace(/[.,!?;:]/g, '')
              .trim()
              .split(/\s+/)
              .filter(word => word.length > 0);
            
            spokenWords = spokenWords.concat(words);
            console.log('Words spoken so far:', spokenWords.length);
          }
          
          document.getElementById('speechText').textContent = transcriptText + interimTranscript;
        };
        
        recognition.onerror = function(event) {
          console.error('Speech recognition error:', event.error);
          isListening = false;
          
          if (event.error === 'not-allowed') {
            status.textContent = '‚ùå Microphone access denied';
            status.className = 'status error';
            troubleshoot.classList.add('show');
          } else if (event.error === 'no-speech') {
            console.log('No speech detected, continuing...');
          } else {
            status.textContent = '‚ùå Speech recognition error: ' + event.error;
            status.className = 'status error';
          }
        };
        
        recognition.onend = function() {
          console.log('Speech recognition ended');
          isListening = false;
          
          if (isRunning) {
            // Restart if session is still active
            setTimeout(() => {
              if (isRunning) {
                try {
                  recognition.start();
                } catch (e) {
                  console.error('Error restarting recognition:', e);
                }
              }
            }, 100);
          } else {
            status.textContent = '‚úÖ Speech recognition ready';
            status.className = 'status ready';
          }
        };
        
        // Test recognition briefly
        recognition.start();
        
        // Stop test after 1 second and show success
        setTimeout(() => {
          if (recognition && isListening) {
            recognition.stop();
            status.textContent = '‚úÖ Speech recognition is ready!';
            status.className = 'status ready';
            
            // Show other buttons
            document.getElementById('initButton').style.display = 'none';
            document.getElementById('testButton').style.display = 'inline-block';
            document.getElementById('startButton').style.display = 'inline-block';
          }
        }, 1000);
        
      } catch (error) {
        console.error('Failed to initialize speech recognition:', error);
        status.textContent = '‚ùå Failed to initialize speech recognition';
        status.className = 'status error';
        troubleshoot.classList.add('show');
      }
    }
    
    // Test speech recognition
    function testSpeech() {
      if (!recognition) return;
      
      const status = document.getElementById('status');
      status.textContent = 'üß™ Testing... Say something!';
      status.className = 'status listening';
      
      document.getElementById('speechText').textContent = 'Testing speech recognition... Say something!';
      
      try {
        recognition.start();
        
        setTimeout(() => {
          if (isListening) {
            recognition.stop();
            status.textContent = '‚úÖ Test complete - speech recognition working!';
            status.className = 'status ready';
          }
        }, 5000);
        
      } catch (error) {
        console.error('Test failed:', error);
        status.textContent = '‚ùå Test failed';
        status.className = 'status error';
      }
    }
    
    // Start practice session
    function startPractice() {
      if (!recognition) {
        alert('Please initialize speech recognition first.');
        return;
      }
      
      // Reset everything
      spokenWords = [];
      transcriptText = '';
      errorDetails = [];
      seconds = 60;
      isRunning = true;
      
      // Update UI
      document.getElementById('testButton').style.display = 'none';
      document.getElementById('startButton').style.display = 'none';
      document.getElementById('stopButton').style.display = 'inline-block';
      document.getElementById('results').classList.remove('active');
      document.getElementById('speechText').textContent = 'Start reading the passage aloud...';
      
      const status = document.getElementById('status');
      status.textContent = 'üìä Reading session active - speak clearly!';
      status.className = 'status listening';
      
      // Start speech recognition
      try {
        recognition.start();
      } catch (error) {
        console.error('Failed to start recognition:', error);
      }
      
      // Start timer
      timer = setInterval(updateTimer, 1000);
    }
    
    // Stop practice
    function stopPractice() {
      clearInterval(timer);
      isRunning = false;
      
      if (recognition && isListening) {
        recognition.stop();
      }
      
      // Calculate results
      calculateResults();
      
      // Update UI
      document.getElementById('stopButton').style.display = 'none';
      document.getElementById('testButton').style.display = 'inline-block';
      document.getElementById('startButton').style.display = 'inline-block';
      
      const status = document.getElementById('status');
      status.textContent = '‚úÖ Reading session complete!';
      status.className = 'status ready';
      
      // Reset timer
      document.getElementById('timer').textContent = '1:00';
      document.getElementById('timer').className = '';
    }
    
    // Update timer
    function updateTimer() {
      seconds--;
      
      const minutes = Math.floor(seconds / 60);
      const secs = seconds % 60;
      const timerElement = document.getElementById('timer');
      timerElement.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
      
      if (seconds <= 10) {
        timerElement.className = 'timer danger';
      } else if (seconds <= 20) {
        timerElement.className = 'timer warning';
      }
      
      if (seconds <= 0) {
        stopPractice();
      }
    }
    
    // Calculate results and errors
    function calculateResults() {
      let correct = 0;
      let incorrect = 0;
      errorDetails = [];
      
      // Compare spoken words to passage
      for (let i = 0; i < Math.max(spokenWords.length, passageWords.length); i++) {
        if (i < spokenWords.length && i < passageWords.length) {
          if (spokenWords[i] === passageWords[i]) {
            correct++;
          } else {
            incorrect++;
            errorDetails.push({
              spoken: spokenWords[i],
              expected: passageWords[i],
              position: i + 1
            });
          }
        } else if (i < passageWords.length) {
          // Word was skipped
          errorDetails.push({
            spoken: 'SKIPPED',
            expected: passageWords[i],
            position: i + 1
          });
        }
      }
      
      const totalWords = spokenWords.length;
      const accuracy = totalWords > 0 ? Math.round((correct / totalWords) * 100) : 0;
      const timeTaken = 60 - seconds;
      const wpm = Math.round((totalWords / timeTaken) * 60);
      
      // Update results display
      document.getElementById('totalWords').textContent = totalWords;
      document.getElementById('correctWords').textContent = correct;
      document.getElementById('incorrectWords').textContent = incorrect;
      document.getElementById('wpm').textContent = wpm;
      document.getElementById('accuracy').textContent = accuracy + '%';
      
      // Show error details
      displayErrors();
      
      // Show results
      document.getElementById('results').classList.add('active');
    }
    
    // Display error analysis
    function displayErrors() {
      const errorList = document.getElementById('errorList');
      errorList.innerHTML = '';
      
      if (errorDetails.length === 0) {
        errorList.innerHTML = '<p style="color: #2e7d32; font-style: italic;">üéâ Perfect! No errors detected!</p>';
        return;
      }
      
      errorDetails.forEach(error => {
        const errorItem = document.createElement('div');
        errorItem.className = 'error-item';
        errorItem.innerHTML = `
          <div>
            <span class="error-spoken">"${error.spoken}"</span>
            ‚Üí
            <span class="error-expected">"${error.expected}"</span>
          </div>
          <small>(Word #${error.position})</small>
        `;
        errorList.appendChild(errorItem);
      });
    }
    
    // Event listeners
    document.getElementById('initButton').addEventListener('click', initializeSpeech);
    document.getElementById('testButton').addEventListener('click', testSpeech);
    document.getElementById('startButton').addEventListener('click', startPractice);
    document.getElementById('stopButton').addEventListener('click', stopPractice);
    
    // Initialize when page loads
    window.addEventListener('load', function() {
      loadPassageWords();
      console.log('Page loaded, ready to initialize speech recognition');
    });
  </script>
</body>
</html>
</artArtifact>

This fixed version should work much better! Here's what I changed to solve the "stuck on checking" issue:

## üîß **Key Fixes:**

### **1. Step-by-Step Initialization:**
- **Manual initialization** - User clicks "Initialize Speech" when ready
- **Quick test** - Only runs recognition for 1 second to verify it works
- **Clear feedback** - Shows exactly what's happening at each step

### **2. Better Error Handling:**
- **Timeout protection** - Stops the test after 1 second
- **Clear error messages** - Tells you exactly what went wrong
- **Fallback options** - Shows troubleshooting tips if it fails

### **3. Simplified Flow:**
1. **Click "Initialize Speech"** ‚Üí Sets up voice recognition
2. **Click "Test Voice"** ‚Üí Quick 5-second test (optional)
3. **Click "Start Practice"** ‚Üí Begin the full session

### **4. No Automatic Initialization:**
- **User-triggered** - Only starts when you're ready
- **No hanging** - Won't get stuck waiting for browser permissions
- **Progressive disclosure** - Shows buttons only when previous step works

### **5. Robust Speech Recognition:**
- **Better restart logic** - Handles recognition stopping/starting
- **Console logging** - Shows what's happening in developer tools
- **Error recovery** - Continues working even if there are hiccups

## üöÄ **To Use This Version:**

1. **Replace your current code** with this version
2. **Open the page** and you'll see "Initialize Speech" button
3. **Click "Initialize Speech"** and allow microphone access
4. **If successful**, you'll see "Test Voice" and "Start Practice" buttons
5. **Click "Start Practice"** to begin the full session

## üîç **If It Still Doesn't Work:**

1. **Check browser** - Use Chrome or Edge
2. **Check URL** - Must be HTTPS (GitHub Pages automatically is)
3. **Check microphone** - Test in other apps first
4. **Check console** - Press F12 and look for error messages
5. **Try incognito mode** - Sometimes browser extensions interfere

This version is much more reliable and will give you clear feedback about what's working and what isn't!
