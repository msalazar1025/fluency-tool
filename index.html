I'll fix both issues - the speech initialization problem and the dropdown passage selection. Here's the corrected version:

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fluency Practice with Homophone Support - Fixed</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      background-color: #f5f5f5;
      padding: 15px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }
    
    .instructions {
      background-color: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 5px solid #2196F3;
    }
    
    .homophone-notice {
      background-color: #e8f5e9;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #4caf50;
    }
    
    .homophone-notice h4 {
      color: #2e7d32;
      margin-bottom: 8px;
    }
    
    .passage-selector {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .passage-selector label {
      font-weight: bold;
      margin-right: 10px;
      color: #333;
    }
    
    .passage-selector select {
      padding: 8px 15px;
      font-size: 16px;
      border: 2px solid #2196F3;
      border-radius: 5px;
      background-color: white;
      cursor: pointer;
      min-width: 300px;
    }
    
    .passage-info {
      background-color: #e8f5e9;
      padding: 10px 15px;
      margin: 10px 0;
      border-radius: 5px;
      text-align: center;
      font-size: 14px;
      color: #2e7d32;
    }
    
    .controls {
      text-align: center;
      margin: 25px 0;
    }
    
    button {
      padding: 12px 30px;
      margin: 10px;
      font-size: 18px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      color: white;
      background-color: #4CAF50;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: #45a049;
    }
    
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .stop-btn {
      background-color: #f44336;
    }
    
    .stop-btn:hover {
      background-color: #d32f2f;
    }
    
    .test-btn {
      background-color: #ff9800;
    }
    
    .test-btn:hover {
      background-color: #f57c00;
    }
    
    #timer {
      font-size: 72px;
      font-weight: bold;
      text-align: center;
      margin: 25px 0;
      color: #333;
    }
    
    .timer.warning {
      color: #ff9800;
    }
    
    .timer.danger {
      color: #f44336;
    }
    
    .status {
      text-align: center;
      padding: 15px;
      margin: 20px 0;
      border-radius: 8px;
      font-weight: bold;
    }
    
    .status.ready {
      background-color: #d4edda;
      color: #155724;
    }
    
    .status.listening {
      background-color: #cce5ff;
      color: #004085;
      animation: pulse 1.5s infinite;
    }
    
    .status.error {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    #speechText {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
      min-height: 80px;
      border: 2px dashed #4caf50;
      max-height: 150px;
      overflow-y: auto;
    }
    
    .passage {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      line-height: 1.8;
      font-size: 18px;
      display: none;
    }
    
    .passage.active {
      display: block;
    }
    
    .passage h3 {
      margin-bottom: 15px;
      color: #333;
      text-align: center;
    }
    
    .passage p {
      margin-bottom: 15px;
      text-indent: 2em;
    }
    
    .word-count-display {
      text-align: right;
      font-size: 14px;
      color: #666;
      font-style: italic;
      margin-top: 10px;
    }
    
    .results {
      background-color: #e8f4f8;
      padding: 25px;
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }
    
    .results.active {
      display: block;
    }
    
    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .result-box {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .result-label {
      font-weight: bold;
      color: #666;
      margin-bottom: 8px;
      font-size: 12px;
    }
    
    .result-value {
      font-size: 24px;
      font-weight: bold;
      color: #2196F3;
    }
    
    .error-analysis {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      border: 2px solid #f44336;
    }
    
    .error-list {
      margin: 15px 0;
    }
    
    .error-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      margin: 8px 0;
      background-color: #ffebee;
      border-radius: 5px;
      border-left: 4px solid #f44336;
    }
    
    .error-spoken {
      font-weight: bold;
      color: #c62828;
    }
    
    .error-expected {
      font-weight: bold;
      color: #2e7d32;
    }
    
    .homophone-accepted {
      background-color: #fff3e0;
      border-left: 4px solid #ff9800;
    }
    
    .homophone-label {
      background-color: #fff9c4;
      color: #f57f17;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 12px;
      margin-left: 8px;
    }
    
    .troubleshoot {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      display: none;
    }
    
    .troubleshoot.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🎯 Fluency Practice with Smart Homophone Recognition</h1>
    
    <div class="homophone-notice">
      <h4>🎉 Smart Homophone Detection Enabled!</h4>
      <p>This tool recognizes words that sound the same but are spelled differently (like "to/too/two", "there/their/they're"). You won't lose points for homophones!</p>
    </div>
    
    <div class="instructions">
      <h3>How to Use:</h3>
      <ol>
        <li>Choose a passage from the dropdown menu below</li>
        <li>Click "Initialize Speech" to set up voice recognition</li>
        <li>If that works, click "Start Practice" to begin</li>
        <li>Read the selected passage aloud for 60 seconds</li>
        <li>See your detailed results with smart homophone checking</li>
      </ol>
    </div>
    
    <div class="passage-selector">
      <label for="passageSelect">📚 Choose a Reading Passage:</label>
      <select id="passageSelect">
        <option value="0">An Unusual Burglar (175 words)</option>
        <option value="1">The Amazing Dolphins (162 words)</option>
        <option value="2">A Day at the Space Center (189 words)</option>
        <option value="3">The Secret Garden Discovery (201 words)</option>
        <option value="4">Building the World's Tallest Tower (195 words)</option>
        <option value="5">The Great Migration Adventure (178 words)</option>
        <option value="6">Cooking with Grandma Rosa (184 words)</option>
        <option value="7">The Mystery of the Missing Homework (167 words)</option>
      </select>
      <div class="passage-info" id="passageInfo">
        Selected: An Unusual Burglar - A story about a cat who "borrows" items from neighbors
      </div>
    </div>
    
    <div class="controls">
      <button id="initButton">Initialize Speech</button>
      <button id="testButton" class="test-btn" style="display: none;">Test Voice</button>
      <button id="startButton" style="display: none;">Start Practice</button>
      <button id="stopButton" class="stop-btn" style="display: none;">Stop</button>
    </div>
    
    <div id="timer">1:00</div>
    
    <div class="status ready" id="status">
      🎤 Click "Initialize Speech" to begin
    </div>
    
    <div class="troubleshoot" id="troubleshoot">
      <h4>🔧 Troubleshooting:</h4>
      <ul>
        <li><strong>Use Chrome or Edge browser</strong> for best results</li>
        <li><strong>Allow microphone access</strong> when prompted</li>
        <li><strong>Check your microphone</strong> is working in other apps</li>
        <li><strong>Try refreshing the page</strong> if it's not working</li>
        <li><strong>Make sure you're on HTTPS</strong> (speech requires secure connection)</li>
      </ul>
    </div>
    
    <div id="speechText">
      Voice recognition results will appear here...
    </div>
    
    <!-- Passage 0: An Unusual Burglar -->
    <div class="passage active" id="passage-0">
      <h3>An Unusual Burglar</h3>
      <p>Theft is a serious crime. If someone stole something from you, you would most likely not be too forgiving. You would probably be very upset if the stealing continued for years. There is a place in California where thefts take place nightly. Strangely, though, most people there just laugh when their items disappear. That is because the culprit is a cat.</p>
      
      <p>Jean Chu and her family adopted Dusty, their pet cat, a few years ago. Not long after he moved in, the family members started finding odd objects lying around. One day they would find a glove and an unfamiliar towel. The next day there would be a pot holder and a sock. At first no one knew what to think about the items that mysteriously appeared on the porch or in the yard. Soon they realized that the objects always showed up in the morning. And which member of the family tended to roam every night? That would be Dusty.</p>
      <div class="word-count-display">Word count: 175</div>
    </div>
    
    <!-- Passage 1: The Amazing Dolphins -->
    <div class="passage" id="passage-1">
      <h3>The Amazing Dolphins</h3>
      <p>Dolphins are some of the smartest animals in the ocean. These incredible marine mammals can learn tricks, solve problems, and even recognize themselves in mirrors. Scientists have discovered that dolphins have their own special language made up of clicks, whistles, and squeaks. Each dolphin has its own signature whistle, just like humans have names.</p>
      
      <p>Dolphins live in groups called pods that can have anywhere from two to thirty members. They work together to hunt for fish and protect each other from sharks. Baby dolphins, called calves, stay close to their mothers for up to six years learning important survival skills. Dolphins are also known for their playful nature. They love to surf ocean waves, play catch with seaweed, and leap high out of the water just for fun.</p>
      
      <p>Perhaps most amazing of all, dolphins have been known to help humans in trouble. There are many stories of dolphins guiding lost swimmers back to shore or protecting people from shark attacks. These friendly ocean creatures truly deserve our respect and protection.</p>
      <div class="word-count-display">Word count: 162</div>
    </div>
    
    <!-- Passage 2: A Day at the Space Center -->
    <div class="passage" id="passage-2">
      <h3>A Day at the Space Center</h3>
      <p>Maria could hardly contain her excitement as the school bus pulled up to the Kennedy Space Center. She had dreamed of becoming an astronaut since she was five years old, and today she would finally see real spaceships up close. Her class lined up eagerly, chattering about rockets and moon landings.</p>
      
      <p>Their first stop was the massive Vehicle Assembly Building, where rockets are put together. The tour guide explained that this building is so enormous that clouds can actually form inside it on humid days. Next, they visited the Space Shuttle Atlantis exhibit. Maria pressed her face against the glass, staring in wonder at the actual spacecraft that had traveled to space thirty-three times.</p>
      
      <p>The highlight of the day was meeting retired astronaut Commander Sarah Chen. She told the students about floating in zero gravity, eating freeze-dried ice cream, and watching Earth from space. "The planet looks like a beautiful blue marble with no borders," she said. "It made me realize how connected we all are." Maria left that day more determined than ever to reach for the stars.</p>
      <div class="word-count-display">Word count: 189</div>
    </div>
    
    <!-- Passage 3: The Secret Garden Discovery -->
    <div class="passage" id="passage-3">
      <h3>The Secret Garden Discovery</h3>
      <p>Emma had always thought the old stone wall behind her grandmother's house was just a boring boundary. But on this sunny Saturday morning, she noticed something different. A small section of the wall had crumbled, revealing a narrow opening covered by thick, tangled vines. Curiosity got the better of her, and she carefully pushed through the green curtain.</p>
      
      <p>What she discovered took her breath away. Hidden behind the wall was a forgotten garden filled with wildflowers, fruit trees, and a small stone fountain that still trickled with clear water. Butterflies danced among the blooms, and a family of rabbits munched peacefully on clover. In the center stood an old wooden bench with a brass plaque that read: "Eleanor's Garden, 1923."</p>
      
      <p>Emma ran back to tell her grandmother about the amazing discovery. Grandma's eyes filled with tears as she explained that Eleanor was her own grandmother, who had created this garden nearly a century ago. Together, they spent the rest of the day clearing weeds and planning how to restore Eleanor's garden to its former glory, creating new memories while honoring old ones.</p>
      <div class="word-count-display">Word count: 201</div>
    </div>
    
    <!-- Passage 4: Building the World's Tallest Tower -->
    <div class="passage" id="passage-4">
      <h3>Building the World's Tallest Tower</h3>
      <p>Construction workers gathered at dawn to begin another day of building the Burj Khalifa, which would soon become the tallest building in the world. The massive skyscraper in Dubai required incredible planning and engineering. Every day, hundreds of workers from over thirty different countries worked together like a well-organized team.</p>
      
      <p>The biggest challenge was pumping concrete to such extreme heights. Engineers had to invent new techniques to push concrete over half a mile straight up without it hardening in the pipes. Special elevators were installed that could travel at amazing speeds, taking workers to the top floors in less than two minutes. The building's unique design, shaped like a desert flower, helped it withstand powerful winds.</p>
      
      <p>After six years of careful construction, the tower finally reached its incredible height of 2,717 feet tall. From the observation deck on the 148th floor, visitors can see for miles across the desert and ocean. The Burj Khalifa stands as proof that when people work together and use creative thinking, they can achieve seemingly impossible dreams and reach new heights.</p>
      <div class="word-count-display">Word count: 195</div>
    </div>
    
    <!-- Passage 5: The Great Migration Adventure -->
    <div class="passage" id="passage-5">
      <h3>The Great Migration Adventure</h3>
      <p>Every year, millions of wildebeest begin one of nature's most spectacular journeys across the African plains. This amazing migration covers over 1,000 miles as the animals search for fresh grass and water. Young David was lucky enough to witness this incredible event during his family's safari vacation in Kenya.</p>
      
      <p>From their jeep, David watched in amazement as thousands of wildebeest stretched as far as he could see across the landscape. The thundering sound of their hooves created a rhythm like distant drums. Zebras and gazelles joined the massive herd, while lions and leopards followed along the edges, hoping for an easy meal.</p>
      
      <p>The most dramatic moment came at the Mara River crossing. David held his breath as the animals plunged into the rushing water, swimming desperately to reach the other side while avoiding hungry crocodiles. Many made it safely across, continuing their ancient journey. This dangerous crossing has been repeated for thousands of years, making it one of the most remarkable wildlife spectacles on Earth.</p>
      <div class="word-count-display">Word count: 178</div>
    </div>
    
    <!-- Passage 6: Cooking with Grandma Rosa -->
    <div class="passage" id="passage-6">
      <h3>Cooking with Grandma Rosa</h3>
      <p>Every Sunday, ten-year-old Antonio looked forward to cooking lessons with his grandmother Rosa. Her kitchen always smelled like garlic, fresh herbs, and love. Today, she was teaching him how to make her famous homemade pasta from scratch, a recipe that had been passed down through four generations of their Italian family.</p>
      
      <p>"First, we make a volcano," Grandma Rosa said with a smile, showing Antonio how to create a well of flour on the wooden cutting board. She cracked fresh eggs into the center and added a pinch of salt. "Now comes the magic," she whispered, teaching him to slowly mix the eggs into the flour using just his fingertips. The sticky dough gradually came together under their hands.</p>
      
      <p>After kneading the golden dough until it was perfectly smooth, they rolled it paper-thin and cut it into long ribbons. As the pasta cooked in boiling water, Grandma Rosa shared stories about her own grandmother in Italy. "Food is more than nourishment," she told Antonio. "It connects us to our family, our history, and our hearts." Antonio knew he would treasure these moments and recipes forever.</p>
      <div class="word-count-display">Word count: 184</div>
    </div>
    
    <!-- Passage 7: The Mystery of the Missing Homework -->
    <div class="passage" id="passage-7">
      <h3>The Mystery of the Missing Homework</h3>
      <p>Jessica couldn't believe it. Her math homework had completely disappeared from her backpack, and it was due first period. She had definitely finished it the night before and clearly remembered putting it in her folder. Now, with only ten minutes before school started, she was frantically searching everywhere.</p>
      
      <p>Her little brother Tommy watched from the doorway with a suspicious grin on his face. "Did you check under your bed?" he asked innocently. Jessica gave him a sharp look but decided to investigate anyway. Sure enough, there was her homework, but it looked different. Someone had drawn funny mustaches on all the numbers and added silly hats to the math symbols.</p>
      
      <p>Jessica couldn't help but laugh at Tommy's artistic additions to her assignment. Even though she was annoyed, his drawings were actually pretty clever. She quickly erased the decorations and made it to class just in time. Later, she told Tommy that while his artwork was impressive, her homework was off-limits. Tommy agreed, but he couldn't promise anything about her science project.</p>
      <div class="word-count-display">Word count: 167</div>
    </div>
    
    <div class="results" id="results">
      <h3>📈 Your Reading Results</h3>
      
      <div class="result-grid">
        <div class="result-box">
          <div class="result-label">Words Spoken</div>
          <div id="totalWords" class="result-value">0</div>
        </div>
        <div class="result-box">
          <div class="result-label">Correct Words</div>
          <div id="correctWords" class="result-value">0</div>
        </div>
        <div class="result-box">
          <div class="result-label">Homophones Accepted</div>
          <div id="homophoneWords" class="result-value">0</div>
        </div>
        <div class="result-box">
          <div class="result-label">Incorrect Words</div>
          <div id="incorrectWords" class="result-value">0</div>
        </div>
        <div class="result-box">
          <div class="result-label">Reading Speed</div>
          <div id="wpm" class="result-value">0</div>
          <div class="result-label">words per minute</div>
        </div>
        <div class="result-box">
          <div class="result-label">Accuracy</div>
          <div id="accuracy" class="result-value">0%</div>
        </div>
      </div>
      
      <div class="error-analysis" id="errorAnalysis">
        <h4>📊 Detailed Word Analysis</h4>
        <div class="error-list" id="errorList">
          <!-- Errors will be shown here -->
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Global variables
    let recognition = null;
    let isRunning = false;
    let isListening = false;
    let timer = null;
    let seconds = 60;
    let spokenWords = [];
    let transcriptText = '';
    let passageWords = [];
    let errorDetails = [];
    let homophoneMatches = [];
    let currentPassageIndex = 0;
    
    // Comprehensive homophone groups
    const homophones = {
      'to': ['to', 'too', 'two'],
      'too': ['to', 'too', 'two'],
      'two': ['to', 'too', 'two'],
      'there': ['there', 'their', 'theyre'],
      'their': ['there', 'their', 'theyre'],
      'theyre': ['there', 'their', 'theyre'],
      'your': ['your', 'youre'],
      'youre': ['your', 'youre'],
      'its': ['its', 'its'],
      'here': ['here', 'hear'],
      'hear': ['here', 'hear'],
      'where': ['where', 'wear', 'were'],
      'wear': ['where', 'wear', 'were'],
      'were': ['where', 'wear', 'were'],
      'no': ['no', 'know'],
      'know': ['no', 'know'],
      'new': ['new', 'knew'],
      'knew': ['new', 'knew'],
      'one': ['one', 'won'],
      'won': ['one', 'won'],
      'write': ['write', 'right', 'rite'],
      'right': ['write', 'right', 'rite'],
      'rite': ['write', 'right', 'rite'],
      'sea': ['sea', 'see'],
      'see': ['sea', 'see'],
      'be': ['be', 'bee'],
      'bee': ['be', 'bee'],
      'for': ['for', 'four', 'fore'],
      'four': ['for', 'four', 'fore'],
      'fore': ['for', 'four', 'fore'],
      'by': ['by', 'buy', 'bye'],
      'buy': ['by', 'buy', 'bye'],
      'bye': ['by', 'buy', 'bye'],
      'son': ['son', 'sun'],
      'sun': ['son', 'sun'],
      'our': ['our', 'hour'],
      'hour': ['our', 'hour'],
      'ate': ['ate', 'eight'],
      'eight': ['ate', 'eight'],
      'break': ['break', 'brake'],
      'brake': ['break', 'brake'],
      'dear': ['dear', 'deer'],
      'deer': ['dear', 'deer'],
      'fair': ['fair', 'fare'],
      'fare': ['fair', 'fare'],
      'flower': ['flower', 'flour'],
      'flour': ['flower', 'flour'],
      'hole': ['hole', 'whole'],
      'whole': ['hole', 'whole'],
      'mail': ['mail', 'male'],
      'male': ['mail', 'male'],
      'meat': ['meat', 'meet'],
      'meet': ['meat', 'meet'],
      'peace': ['peace', 'piece'],
      'piece': ['peace', 'piece'],
      'plain': ['plain', 'plane'],
      'plane': ['plain', 'plane'],
      'rain': ['rain', 'reign', 'rein'],
      'reign': ['rain', 'reign', 'rein'],
      'rein': ['rain', 'reign', 'rein'],
      'red': ['red', 'read'],
      'read': ['red', 'read'],
      'road': ['road', 'rode'],
      'rode': ['road', 'rode'],
      'sail': ['sail', 'sale'],
      'sale': ['sail', 'sale'],
      'tail': ['tail', 'tale'],
      'tale': ['tail', 'tale'],
      'threw': ['threw', 'through'],
      'through': ['threw', 'through'],
      'wait': ['wait', 'weight'],
      'weight': ['wait', 'weight'],
      'way': ['way', 'weigh'],
      'weigh': ['way', 'weigh'],
      'weak': ['weak', 'week'],
      'week': ['weak', 'week'],
      'which': ['which', 'witch'],
      'witch': ['which', 'witch'],
      'wood': ['wood', 'would'],
      'would': ['wood', 'would']
    };
    
    // Function to check if two words are homophones
    function areHomophones(word1, word2) {
      word1 = word1.toLowerCase();
      word2 = word2.toLowerCase();
      
      if (word1 === word2) return true;
      
      if (homophones[word1] && homophones[word1].includes(word2)) {
        return true;
      }
      
      return false;
    }
    
    // Passage descriptions
    const passageDescriptions = [
      "An Unusual Burglar - A story about a cat who 'borrows' items from neighbors",
      "The Amazing Dolphins - Learn about these intelligent ocean creatures",
      "A Day at the Space Center - A student's exciting visit to see real spaceships",
      "The Secret Garden Discovery - Finding a hidden garden behind an old wall",
      "Building the World's Tallest Tower - The construction of the Burj Khalifa",
      "The Great Migration Adventure - Witnessing wildebeest crossing African plains",
      "Cooking with Grandma Rosa - Learning family recipes and traditions",
      "The Mystery of the Missing Homework - A funny story about sibling pranks"
    ];
    
    // Change passage function - FIXED
    function changePassage() {
      const selectElement = document.getElementById('passageSelect');
      const selectedIndex = parseInt(selectElement.value);
      const passageInfo = document.getElementById('passageInfo');
      
      console.log('Changing to passage:', selectedIndex);
      
      // Hide all passages
      document.querySelectorAll('.passage').forEach(passage => {
        passage.classList.remove('active');
      });
      
      // Show selected passage
      const targetPassage = document.getElementById(`passage-${selectedIndex}`);
      if (targetPassage) {
        targetPassage.classList.add('active');
        console.log('Activated passage:', selectedIndex);
      } else {
        console.error('Passage not found:', `passage-${selectedIndex}`);
      }
      
      // Update passage info
      passageInfo.textContent = `Selected: ${passageDescriptions[selectedIndex]}`;
      
      // Update current passage index
      currentPassageIndex = selectedIndex;
      
      // Reload passage words
      loadPassageWords();
    }
    
    // Get passage words for comparison
    function loadPassageWords() {
      const activePassage = document.querySelector('.passage.active');
      if (!activePassage) {
        console.error('No active passage found');
        return;
      }
      
      const passageText = activePassage.innerText
        .replace(/Word count: \d+/g, '')
        .replace(/^[A-Za-z\s']+(?=\n)/m, '') // Remove title
        .toLowerCase()
        .replace(/[.,!?;:"]/g, '')
        .split(/\s+/)
        .filter(word => word.length > 0);
      
      passageWords = passageText;
      console.log(`Loaded passage ${currentPassageIndex}:`, passageWords.length, 'words');
    }
    
    // Initialize speech recognition - FIXED
    function
    
    initializeSpeech() {
      const status = document.getElementById('status');
      const troubleshoot = document.getElementById('troubleshoot');
      console.log('Starting speech initialization...');
  status.textContent = '🔄 Setting up speech recognition...';
  status.className = 'status';
  
  // Check browser support
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    console.error('Speech recognition not supported');
    status.textContent = '❌ Speech recognition not supported in this browser';
    status.className = 'status error';
    troubleshoot.classList.add('show');
    return;
  }
  
  try {
    // Create recognition object
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    
    console.log('Created speech recognition object');
    
    // Configure recognition
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-US';
    recognition.maxAlternatives = 1;
    
    console.log('Configured speech recognition');
    
    // Set up event handlers
    recognition.onstart = function() {
      console.log('Speech recognition started');
      isListening = true;
      status.textContent = '🎤 Speech recognition is listening...';
      status.className = 'status listening';
    };
    
    recognition.onresult = function(event) {
      let interimTranscript = '';
      let finalTranscript = '';
      
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          finalTranscript += transcript + ' ';
        } else {
          interimTranscript += transcript;
        }
      }
      
      if (finalTranscript) {
        transcriptText += finalTranscript;
        const words = finalTranscript
          .toLowerCase()
          .replace(/[.,!?;:"]/g, '')
          .trim()
          .split(/\s+/)
          .filter(word => word.length > 0);
        
        spokenWords = spokenWords.concat(words);
        console.log('Words spoken so far:', spokenWords.length);
      }
      
      document.getElementById('speechText').textContent = transcriptText + interimTranscript;
    };
    
    recognition.onerror = function(event) {
      console.error('Speech recognition error:', event.error);
      isListening = false;
      
      if (event.error === 'not-allowed') {
        status.textContent = '❌ Microphone access denied - please allow and try again';
        status.className = 'status error';
        troubleshoot.classList.add('show');
      } else if (event.error === 'no-speech') {
        console.log('No speech detected, continuing...');
        // Don't show error for no-speech, it's normal
      } else {
        status.textContent = '❌ Speech error: ' + event.error;
        status.className = 'status error';
      }
    };
    
    recognition.onend = function() {
      console.log('Speech recognition ended');
      isListening = false;
      
      if (isRunning) {
        // Restart if session is still active
        setTimeout(() => {
          if (isRunning && recognition) {
            try {
              console.log('Restarting speech recognition...');
              recognition.start();
            } catch (e) {
              console.error('Error restarting recognition:', e);
            }
          }
        }, 100);
      } else {
        status.textContent = '✅ Speech recognition ready';
        status.className = 'status ready';
      }
    };
    
    console.log('Set up event handlers, testing recognition...');
    
    // Test recognition briefly
    recognition.start();
    
    // Stop test after 2 seconds and show success
    setTimeout(() => {
      if (recognition && isListening) {
        console.log('Test successful, stopping...');
        recognition.stop();
        
        setTimeout(() => {
          status.textContent = '✅ Speech recognition is ready!';
          status.className = 'status ready';
          
          // Show other buttons
          document.getElementById('initButton').style.display = 'none';
          document.getElementById('testButton').style.display = 'inline-block';
          document.getElementById('startButton').style.display = 'inline-block';
          
          console.log('Speech initialization complete');
        }, 500);
      }
    }, 2000);
    
  } catch (error) {
    console.error('Failed to initialize speech recognition:', error);
    status.textContent = '❌ Failed to initialize speech recognition';
    status.className = 'status error';
    troubleshoot.classList.add('show');
  }
}

// Test speech recognition
function testSpeech() {
  if (!recognition) {
    console.error('Recognition not initialized');
    return;
  }
  
  const status = document.getElementById('status');
  status.textContent = '🧪 Testing... Say something!';
  status.className = 'status listening';
  
  document.getElementById('speechText').textContent = 'Testing speech recognition... Say something!';
  
  try {
    recognition.start();
    
    setTimeout(() => {
      if (isListening) {
        recognition.stop();
        status.textContent = '✅ Test complete - speech recognition working!';
        status.className = 'status ready';
      }
    }, 5000);
    
  } catch (error) {
    console.error('Test failed:', error);
    status.textContent = '❌ Test failed - ' + error.message;
    status.className = 'status error';
  }
}

// Start practice session
function startPractice() {
  if (!recognition) {
    alert('Please initialize speech recognition first.');
    return;
  }
  
  console.log('Starting practice session...');
  
  // Reset everything
  spokenWords = [];
  transcriptText = '';
  errorDetails = [];
  homophoneMatches = [];
  seconds = 60;
  isRunning = true;
  
  // Update UI
  document.getElementById('testButton').style.display = 'none';
  document.getElementById('startButton').style.display = 'none';
  document.getElementById('stopButton').style.display = 'inline-block';
  document.getElementById('results').classList.remove('active');
  document.getElementById('speechText').textContent = 'Start reading the passage aloud...';
  
  const status = document.getElementById('status');
  status.textContent = '📊 Reading session active - speak clearly!';
  status.className = 'status listening';
  
  // Start speech recognition
  try {
    recognition.start();
    console.log('Started speech recognition for practice');
  } catch (error) {
    console.error('Failed to start recognition:', error);
    if (error.name === 'InvalidStateError') {
      // Already running, stop and restart
      recognition.stop();
      setTimeout(() => {
        try {
          recognition.start();
        } catch (e) {
          console.error('Failed to restart:', e);
        }
      }, 100);
    }
  }
  
  // Start timer
  timer = setInterval(updateTimer, 1000);
}

// Stop practice
function stopPractice() {
  console.log('Stopping practice session...');
  
  clearInterval(timer);
  isRunning = false;
  
  if (recognition && isListening) {
    recognition.stop();
  }
  
  // Calculate results with homophone checking
  calculateResults();
  
  // Update UI
  document.getElementById('stopButton').style.display = 'none';
  document.getElementById('testButton').style.display = 'inline-block';
  document.getElementById('startButton').style.display = 'inline-block';
  
  const status = document.getElementById('status');
  status.textContent = '✅ Reading session complete!';
  status.className = 'status ready';
  
  // Reset timer
  document.getElementById('timer').textContent = '1:00';
  document.getElementById('timer').className = '';
}

// Update timer
function updateTimer() {
  seconds--;
  
  const minutes = Math.floor(seconds / 60);
  const secs = seconds % 60;
  const timerElement = document.getElementById('timer');
  timerElement.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
  
  if (seconds <= 10) {
    timerElement.className = 'timer danger';
  } else if (seconds <= 20) {
    timerElement.className = 'timer warning';
  }
  
  if (seconds <= 0) {
    stopPractice();
  }
}

// Calculate results with smart homophone checking
function calculateResults() {
  let correct = 0;
  let incorrect = 0;
  let homophoneCount = 0;
  errorDetails = [];
  homophoneMatches = [];
  
  console.log('Calculating results with homophone checking...');
  console.log('Spoken words:', spokenWords);
  console.log('Passage words:', passageWords);
  
  // Compare spoken words to passage with homophone intelligence
  for (let i = 0; i < Math.max(spokenWords.length, passageWords.length); i++) {
    if (i < spokenWords.length && i < passageWords.length) {
      const spokenWord = spokenWords[i];
      const expectedWord = passageWords[i];
      
      if (spokenWord === expectedWord) {
        // Exact match
        correct++;
        console.log(`✅ Exact match: "${spokenWord}"`);
      } else if (areHomophones(spokenWord, expectedWord)) {
        // Homophone match - count as correct
        correct++;
        homophoneCount++;
        homophoneMatches.push({
          spoken: spokenWord,
          expected: expectedWord,
          position: i + 1
        });
        console.log(`🎯 Homophone match: "${spokenWord}" ≈ "${expectedWord}"`);
      } else {
        // Real error
        incorrect++;
        errorDetails.push({
          type: 'substitution',
          spoken: spokenWord,
          expected: expectedWord,
          position: i + 1
        });
        console.log(`❌ Mismatch: "${spokenWord}" ≠ "${expectedWord}"`);
      }
    } else if (i < passageWords.length) {
      // Word was skipped
      errorDetails.push({
        type: 'omission',
        expected: passageWords[i],
        position: i + 1
      });
      console.log(`⏭️ Skipped: "${passageWords[i]}"`);
    }
  }
  
  const totalWords = spokenWords.length;
  const accuracy = totalWords > 0 ? Math.round((correct / totalWords) * 100) : 0;
  const timeTaken = 60 - seconds;
  const wpm = Math.round((totalWords / timeTaken) * 60);
  
  console.log(`Results: ${correct} correct, ${homophoneCount} homophones, ${incorrect} incorrect`);
  
  // Update results display
  document.getElementById('totalWords').textContent = totalWords;
  document.getElementById('correctWords').textContent = correct - homophoneCount; // Exact matches only
  document.getElementById('homophoneWords').textContent = homophoneCount;
  document.getElementById('incorrectWords').textContent = incorrect;
  document.getElementById('wpm').textContent = wpm;
  document.getElementById('accuracy').textContent = accuracy + '%';
  
  // Show detailed analysis
  displayDetailedAnalysis();
  
  // Show results
  document.getElementById('results').classList.add('active');
}

// Display detailed error and homophone analysis
function displayDetailedAnalysis() {
  const errorList = document.getElementById('errorList');
  errorList.innerHTML = '';
  
  // Show homophones first (positive feedback)
  if (homophoneMatches.length > 0) {
    const homophoneHeader = document.createElement('div');
    homophoneHeader.innerHTML = '<h5 style="color: #f57c00; margin: 15px 0 10px 0;">🎯 Smart Homophone Matches (Counted as Correct)</h5>';
    errorList.appendChild(homophoneHeader);
    
    homophoneMatches.forEach(match => {
      const homophoneItem = document.createElement('div');
      homophoneItem.className = 'error-item homophone-accepted';
      homophoneItem.innerHTML = `
        <div>
          <span class="error-spoken">"${match.spoken}"</span>
          ≈
          <span class="error-expected">"${match.expected}"</span>
          <span class="homophone-label">HOMOPHONE</span>
        </div>
        <small>(Word #${match.position})</small>
      `;
      errorList.appendChild(homophoneItem);
    });
  }
  
  // Show actual errors
  if (errorDetails.length > 0) {
    const errorHeader = document.createElement('div');
    errorHeader.innerHTML = '<h5 style="color: #c62828; margin: 15px 0 10px 0;">❌ Words That Need Practice</h5>';
    errorList.appendChild(errorHeader);
    
    errorDetails.forEach(error => {
      const errorItem = document.createElement('div');
      errorItem.className = 'error-item';
      
      if (error.type === 'substitution') {
        errorItem.innerHTML = `
          <div>
            <span class="error-spoken">"${error.spoken}"</span>
            →
            <span class="error-expected">"${error.expected}"</span>
          </div>
          <small>(Word #${error.position})</small>
        `;
      } else if (error.type === 'omission') {
        errorItem.innerHTML = `
          <div>
            <span class="error-spoken">SKIPPED</span>
            →
            <span class="error-expected">"${error.expected}"</span>
          </div>
          <small>(Word #${error.position})</small>
        `;
      }
      
      errorList.appendChild(errorItem);
    });
  }
  
  // Show success message if no real errors
  if (errorDetails.length === 0 && homophoneMatches.length === 0) {
    errorList.innerHTML = '<p style="color: #2e7d32; font-style: italic; text-align: center; padding: 20px;">🎉 Perfect! No errors detected!</p>';
  } else if (errorDetails.length === 0) {
    const successMessage = document.createElement('div');
    successMessage.innerHTML = '<p style="color: #2e7d32; font-style: italic; text-align: center; padding: 10px;">🌟 Excellent! Only homophone variations detected - no real errors!</p>';
    errorList.appendChild(successMessage);
  }
}

// Set up event listeners
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, setting up event listeners...');
  
  // Dropdown change listener
  const passageSelect = document.getElementById('passageSelect');
  passageSelect.addEventListener('change', changePassage);
  
  // Button listeners
  document.getElementById('initButton').addEventListener('click', initializeSpeech);
  document.getElementById('testButton').addEventListener('click', testSpeech);
  document.getElementById('startButton').addEventListener('click', startPractice);
  document.getElementById('stopButton').addEventListener('click', stopPractice);
  
  // Load initial passage
  loadPassageWords();
  
  console.log('Setup complete');
});

// Initialize when page loads (fallback)
window.addEventListener('load', function() {
  console.log('Window loaded');
  
  // Ensure passage words are loaded
  if (passageWords.length === 0) {
    loadPassageWords();
  }
  
  // Log homophone database info
  console.log('Homophone database contains', Object.keys(homophones).length, 'word groups');
});

</script>
</body>
</html>
